<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>FPL Overlay â€” OBS</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg:#080c14;--s1:#0d1220;--s2:#111827;--s3:#162033;
      --bd:#1a2840;--ac:#00d4aa;--bl:#3b82f6;--am:#f59e0b;
      --dg:#ef4444;--pu:#a855f7;--tx:#e2e8f0;--mt:#4a5f7a;
      --fh:'Bebas Neue',sans-serif;
      --fb:'DM Sans',sans-serif;
      --fm:'JetBrains Mono',monospace;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

    /* â”€â”€ OBS transparent base â”€â”€ */
    html,body{
      width:1920px;height:1080px;
      background:transparent;
      overflow:hidden;
      font-family:var(--fb);
    }
    body.preview-mode{
      background:rgba(0,0,0,.85);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SETTINGS PANEL (preview only)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #settings-panel{
      position:fixed;top:0;left:0;right:0;bottom:88px;
      background:var(--bg);
      z-index:999;
      overflow-y:auto;
      display:none;
      padding:2rem;
    }
    #settings-panel.open{ display:block; }

    .sp-header{
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom:2rem;
      padding-bottom:1rem;
      border-bottom:1px solid var(--bd);
    }
    .sp-title{font-family:var(--fh);font-size:2.5rem;letter-spacing:3px;color:var(--ac)}
    .sp-close{
      font-family:var(--fm);font-size:.72rem;letter-spacing:1px;
      padding:.5rem 1.2rem;border-radius:8px;border:1px solid var(--bd);
      background:transparent;color:var(--mt);cursor:pointer;transition:all .2s;
    }
    .sp-close:hover{border-color:var(--dg);color:var(--dg)}

    .sp-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem}
    @media(max-width:1200px){.sp-grid{grid-template-columns:repeat(2,1fr)}}

    .sp-box{
      background:var(--s1);border:1px solid var(--bd);
      border-radius:14px;padding:1.5rem;
    }
    .sp-box-title{
      font-family:var(--fh);font-size:1.1rem;letter-spacing:2px;
      margin-bottom:1.25rem;display:flex;align-items:center;gap:.6rem;
    }
    .sp-box-title span{font-size:1.2rem}

    .sp-row{display:flex;flex-direction:column;gap:.3rem;margin-bottom:.9rem}
    .sp-row:last-child{margin-bottom:0}
    .sp-label{font-family:var(--fm);font-size:.62rem;color:var(--mt);letter-spacing:1px;text-transform:uppercase}
    .sp-input{
      background:var(--s2);border:1px solid var(--bd);border-radius:7px;
      padding:.45rem .8rem;color:var(--tx);font-family:var(--fm);font-size:.82rem;
      outline:none;transition:border-color .2s;width:100%;
    }
    .sp-input:focus{border-color:var(--ac)}
    .sp-input::placeholder{color:var(--mt)}
    select.sp-input{cursor:pointer}
    .sp-btn{
      font-family:var(--fm);font-size:.68rem;letter-spacing:1px;
      padding:.45rem 1rem;border-radius:7px;border:none;
      cursor:pointer;transition:all .2s;font-weight:700;width:100%;margin-top:.25rem;
    }
    .sp-btn.green{background:rgba(0,212,170,.15);color:var(--ac);border:1px solid rgba(0,212,170,.3)}
    .sp-btn.green:hover{background:var(--ac);color:#000}
    .sp-btn.blue{background:rgba(59,130,246,.15);color:var(--bl);border:1px solid rgba(59,130,246,.3)}
    .sp-btn.blue:hover{background:var(--bl);color:#fff}
    .sp-btn.amber{background:rgba(245,158,11,.15);color:var(--am);border:1px solid rgba(245,158,11,.3)}
    .sp-btn.amber:hover{background:var(--am);color:#000}
    .sp-btn.danger{background:rgba(239,68,68,.15);color:var(--dg);border:1px solid rgba(239,68,68,.3)}
    .sp-btn.danger:hover{background:var(--dg);color:#fff}
    .sp-btn.purple{background:rgba(168,85,247,.15);color:var(--pu);border:1px solid rgba(168,85,247,.3)}
    .sp-btn.purple:hover{background:var(--pu);color:#fff}

    .sp-toggle-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem}
    .sp-toggle-lbl{font-size:.82rem;font-weight:600}
    .toggle{
      width:40px;height:22px;border-radius:11px;position:relative;
      cursor:pointer;border:none;transition:background .2s;flex-shrink:0;
    }
    .toggle.on{background:var(--ac)}.toggle.off{background:var(--mt)}
    .toggle::after{
      content:'';position:absolute;top:3px;width:16px;height:16px;border-radius:50%;background:#fff;
      transition:left .2s;
    }
    .toggle.on::after{left:21px}.toggle.off::after{left:3px}

    .sp-status{
      display:flex;align-items:center;gap:.5rem;
      font-family:var(--fm);font-size:.65rem;
      padding:.35rem .75rem;border-radius:12px;
      background:var(--s2);border:1px solid var(--bd);
      margin-top:.5rem;
    }
    .ssdot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
    .ssdot.ok{background:var(--ac)}.ssdot.err{background:var(--dg)}.ssdot.warn{background:var(--am)}

    .url-box{
      background:var(--s2);border:1px solid var(--bd);border-radius:8px;
      padding:.6rem .9rem;font-family:var(--fm);font-size:.65rem;
      color:var(--ac);word-break:break-all;line-height:1.6;
      margin-top:.5rem;cursor:pointer;transition:background .2s;
    }
    .url-box:hover{background:rgba(0,212,170,.05)}
    .url-copy-hint{font-size:.58rem;color:var(--mt);margin-top:.25rem}

    .score-ctrl{display:flex;align-items:center;gap:.5rem;justify-content:center;margin:.5rem 0}
    .sc-btn{width:32px;height:32px;border-radius:7px;border:none;cursor:pointer;font-size:1.1rem;transition:all .15s;display:flex;align-items:center;justify-content:center}
    .sc-btn.plus{background:rgba(0,212,170,.15);color:var(--ac)}.sc-btn.plus:hover{background:var(--ac);color:#000}
    .sc-btn.minus{background:rgba(239,68,68,.15);color:var(--dg)}.sc-btn.minus:hover{background:var(--dg);color:#fff}
    .sc-num{font-family:var(--fh);font-size:2rem;min-width:36px;text-align:center;color:var(--tx)}

    .poll-bars-preview{display:flex;flex-direction:column;gap:.4rem;margin-top:.5rem}
    .pb-row{display:flex;align-items:center;gap:.5rem}
    .pb-lbl{font-size:.68rem;color:var(--mt);width:60px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pb-wrap{flex:1;height:8px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden}
    .pb-fill{height:100%;border-radius:4px;transition:width .8s ease}
    .pb-fill.c0{background:var(--bl)}.pb-fill.c1{background:var(--dg)}.pb-fill.c2{background:var(--am)}
    .pb-pct{font-family:var(--fm);font-size:.62rem;color:var(--mt);width:28px;text-align:right}

    /* â”€â”€ Settings Toggle Button (always visible) â”€â”€ */
    #settings-btn{
      position:fixed;top:16px;right:20px;z-index:1000;
      font-family:var(--fm);font-size:.65rem;letter-spacing:1px;
      padding:.4rem .9rem;border-radius:8px;
      border:1px solid var(--bd);
      background:rgba(13,18,32,.92);color:var(--mt);
      cursor:pointer;transition:all .2s;backdrop-filter:blur(10px);
    }
    #settings-btn:hover{border-color:var(--ac);color:var(--ac)}
    body:not(.preview-mode) #settings-btn{display:none}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       OVERLAY ROOT â€” bottom bar
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #overlay-root{
      position:absolute;bottom:0;left:0;right:0;
      display:flex;flex-direction:column;
      pointer-events:none;
    }

    /* â”€â”€ Top Strip â”€â”€ */
    #top-strip{
      display:flex;justify-content:space-between;align-items:flex-end;
      padding:0 20px 5px;gap:10px;
    }

    /* Score Ticker */
    .ticker-wrap{
      display:flex;align-items:center;
      background:rgba(5,8,18,.94);border:1px solid var(--bd);
      border-bottom:none;border-radius:10px 10px 0 0;
      overflow:hidden;height:36px;flex:1;max-width:860px;
    }
    .ticker-label{
      background:var(--bl);color:#fff;
      font-family:var(--fh);font-size:.8rem;letter-spacing:2px;
      padding:0 14px;height:100%;display:flex;align-items:center;white-space:nowrap;flex-shrink:0;
    }
    .ticker-track{overflow:hidden;flex:1;height:100%;position:relative}
    .ticker-inner{display:flex;align-items:center;height:100%;white-space:nowrap;animation:ticker-scroll 30s linear infinite}
    .ticker-item{display:inline-flex;align-items:center;gap:7px;padding:0 18px;border-right:1px solid var(--bd);height:100%;font-size:.75rem;font-weight:600}
    .t-score{font-family:var(--fm);font-size:.82rem;font-weight:700;padding:1px 7px;border-radius:3px}
    .t-score.live{color:var(--dg);background:rgba(239,68,68,.12);animation:pulse 1.5s infinite}
    .t-score.ft{color:var(--ac);background:rgba(0,212,170,.1)}
    .t-score.up{color:rgba(255,255,255,.4);background:rgba(255,255,255,.05)}
    @keyframes ticker-scroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}

    /* Countdown */
    .countdown-widget{
      background:rgba(5,8,18,.94);border:1px solid var(--bd);
      border-bottom:none;border-radius:10px 10px 0 0;
      padding:5px 14px;display:flex;align-items:center;gap:8px;height:36px;
    }
    .cd-label{font-family:var(--fm);font-size:.58rem;color:rgba(255,255,255,.35);letter-spacing:2px}
    .cd-time{font-family:var(--fh);font-size:.95rem;color:var(--am);letter-spacing:2px}
    .cd-dot{width:6px;height:6px;border-radius:50%;background:var(--dg);animation:pulse 1s infinite}

    /* â”€â”€ Main Bar â”€â”€ */
    #main-bar{
      background:rgba(8,12,20,.94);
      border-top:2px solid var(--ac);
      display:flex;align-items:stretch;
      height:82px;
    }
    .bar-div{width:1px;background:var(--bd);flex-shrink:0}

    /* Brand */
    .seg-brand{display:flex;align-items:center;padding:0 18px;gap:8px;flex-shrink:0;background:rgba(0,212,170,.05)}
    .brand-txt{font-family:var(--fh);font-size:1.5rem;letter-spacing:3px;color:var(--ac)}
    .brand-txt span{color:var(--tx)}
    .brand-gw{font-family:var(--fm);font-size:.56rem;color:rgba(255,255,255,.3);letter-spacing:2px}

    /* Match Score (Watch Along) */
    .seg-match{display:flex;align-items:center;padding:0 16px;gap:12px;flex-shrink:0;background:rgba(0,212,170,.03)}
    .match-team{display:flex;align-items:center;gap:6px}
    .match-badge{width:28px;height:28px;object-fit:contain;filter:drop-shadow(0 1px 3px rgba(0,0,0,.5))}
    .match-badge-fb{width:28px;height:28px;border-radius:50%;background:var(--s2);border:1px solid var(--bd);display:flex;align-items:center;justify-content:center;font-size:.8rem}
    .match-team-name{font-family:var(--fh);font-size:.85rem;letter-spacing:1px}
    .match-scoreboard{
      display:flex;align-items:center;
      background:var(--s2);border:1px solid var(--bd);border-radius:8px;overflow:hidden;
    }
    .match-score-num{
      font-family:var(--fh);font-size:1.8rem;letter-spacing:1px;
      padding:0 12px;min-width:46px;text-align:center;
    }
    .match-score-num.home{color:var(--ac)}.match-score-num.away{color:var(--bl)}
    .match-score-sep{width:1px;height:40px;background:var(--bd)}
    .match-state-badge{
      font-family:var(--fm);font-size:.55rem;padding:2px 7px;border-radius:10px;margin-left:6px;
    }
    .match-state-badge.live{background:rgba(239,68,68,.15);color:var(--dg);border:1px solid rgba(239,68,68,.3);animation:pulse 2s infinite}
    .match-state-badge.ht{background:rgba(245,158,11,.12);color:var(--am);border:1px solid rgba(245,158,11,.2)}
    .match-state-badge.ft{background:rgba(0,212,170,.1);color:var(--ac);border:1px solid rgba(0,212,170,.2)}
    .match-state-badge.pre{background:rgba(255,255,255,.06);color:var(--mt);border:1px solid var(--bd)}

    /* My Team */
    .seg-myteam{display:flex;align-items:center;padding:0 16px;gap:14px;flex-shrink:0}
    .myteam-lbl{font-family:var(--fm);font-size:.6rem;letter-spacing:2px;color:rgba(255,255,255,.3);writing-mode:vertical-rl;transform:rotate(180deg)}
    .myteam-stats{display:flex;gap:12px;align-items:center}
    .mt-stat{text-align:center}
    .mt-val{font-family:var(--fh);font-size:1.5rem;letter-spacing:1px;line-height:1}
    .mt-val.pts{color:var(--ac)}.mt-val.rank{color:var(--bl)}
    .mt-key{font-size:.55rem;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:1.5px;margin-top:2px}
    .mt-sep{width:1px;height:32px;background:var(--bd)}

    /* Captain */
    .seg-captain{display:flex;align-items:center;padding:0 16px;gap:10px;flex-shrink:0}
    .cap-kit{width:48px;height:48px;object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,.5));position:relative}
    .cap-kit-wrap{position:relative;flex-shrink:0}
    .cap-c-badge{
      position:absolute;bottom:-2px;right:-2px;
      width:16px;height:16px;border-radius:50%;
      background:var(--am);color:#000;
      font-family:var(--fh);font-size:.55rem;
      display:flex;align-items:center;justify-content:center;
      border:1.5px solid rgba(8,12,20,.94);z-index:2;
    }
    .cap-info{display:flex;flex-direction:column;gap:2px}
    .cap-label{font-size:.55rem;color:rgba(255,255,255,.3);letter-spacing:2px;text-transform:uppercase}
    .cap-name{font-family:var(--fh);font-size:1rem;letter-spacing:1px;line-height:1}
    .cap-pts{font-family:var(--fm);font-size:.7rem;color:var(--am)}

    /* Hot Player */
    .seg-hot{display:flex;align-items:center;padding:0 14px;gap:10px;flex-shrink:0;background:rgba(245,158,11,.03)}
    .hot-kit{width:44px;height:44px;object-fit:contain;filter:drop-shadow(0 1px 3px rgba(0,0,0,.4))}
    .hot-info{display:flex;flex-direction:column;gap:2px}
    .hot-label{font-size:.55rem;color:rgba(255,255,255,.3);letter-spacing:2px;text-transform:uppercase}
    .hot-name{font-family:var(--fh);font-size:.95rem;letter-spacing:1px;line-height:1}
    .hot-meta{display:flex;gap:5px;align-items:center}
    .hot-form{font-family:var(--fm);font-size:.65rem;color:var(--am)}
    .hot-price{font-family:var(--fm);font-size:.65rem;color:rgba(255,255,255,.35)}
    .fdr-p{display:inline-block;width:7px;height:7px;border-radius:2px}
    .fdr-1,.fdr-2{background:var(--ac)}.fdr-3{background:var(--am)}.fdr-4,.fdr-5{background:var(--dg)}

    /* Prediction */
    .seg-predict{display:flex;align-items:center;padding:0 14px;gap:12px;flex:1}
    .pred-label{font-size:.55rem;color:rgba(255,255,255,.3);letter-spacing:2px;text-transform:uppercase;white-space:nowrap}
    .pred-match{display:flex;align-items:center;gap:8px}
    .pred-team{font-family:var(--fh);font-size:.95rem;letter-spacing:1px}
    .pred-score-box{display:flex;align-items:center;gap:3px}
    .pred-score{font-family:var(--fm);font-size:1rem;font-weight:700;width:24px;height:24px;border-radius:4px;display:flex;align-items:center;justify-content:center}
    .pred-score.p{color:var(--bl);background:rgba(59,130,246,.12)}
    .pred-score.a{color:var(--ac);background:rgba(0,212,170,.1)}
    .pred-vs{font-family:var(--fm);font-size:.6rem;color:rgba(255,255,255,.25)}
    .pred-divider{width:1px;height:28px;background:var(--bd)}
    .pred-result{font-family:var(--fm);font-size:.62rem;padding:2px 7px;border-radius:4px}
    .pred-result.correct{background:rgba(0,212,170,.15);color:var(--ac)}
    .pred-result.wrong{background:rgba(239,68,68,.15);color:var(--dg)}
    .pred-result.pending{background:rgba(245,158,11,.1);color:var(--am)}

    /* Poll */
    .seg-poll{display:flex;align-items:center;padding:0 14px;gap:12px;flex-shrink:0;background:rgba(168,85,247,.03)}
    .poll-info{display:flex;flex-direction:column;gap:4px;min-width:155px}
    .poll-q{font-size:.62rem;color:rgba(255,255,255,.45);line-height:1.3;max-width:155px}
    .poll-bars{display:flex;flex-direction:column;gap:3px}
    .poll-row{display:flex;align-items:center;gap:5px}
    .poll-opt-lbl{font-size:.56rem;color:rgba(255,255,255,.35);width:26px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .poll-bar-wrap{flex:1;height:5px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden}
    .poll-bar-fill{height:100%;border-radius:3px;transition:width 1s ease}
    .poll-bar-fill.c0{background:var(--bl)}.poll-bar-fill.c1{background:var(--dg)}.poll-bar-fill.c2{background:var(--am)}
    .poll-pct{font-family:var(--fm);font-size:.58rem;color:rgba(255,255,255,.4);width:26px;text-align:right}

    /* â”€â”€ Animations â”€â”€ */
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    #overlay-root{animation:slideUp .5s ease forwards}
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SETTINGS PANEL (preview-mode only)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<button id="settings-btn" onclick="toggleSettings()">âš™ï¸ OVERLAY SETTINGS</button>

<div id="settings-panel">
  <div class="sp-header">
    <div class="sp-title">âš™ï¸ OVERLAY SETTINGS</div>
    <button class="sp-close" onclick="toggleSettings()">âœ• CLOSE & PREVIEW</button>
  </div>

  <div class="sp-grid">

    <!-- â‘  MATCH SETUP -->
    <div class="sp-box">
      <div class="sp-box-title"><span>âš½</span> Match Setup</div>

      <div class="sp-row">
        <div class="sp-label">Home Team</div>
        <input class="sp-input" id="cfg-home" placeholder="Arsenal"/>
      </div>
      <div class="sp-row">
        <div class="sp-label">Home Team ID (FPL)</div>
        <input class="sp-input" id="cfg-home-id" placeholder="1 = Arsenal" type="number"/>
      </div>
      <div class="sp-row">
        <div class="sp-label">Away Team</div>
        <input class="sp-input" id="cfg-away" placeholder="Man City"/>
      </div>
      <div class="sp-row">
        <div class="sp-label">Away Team ID (FPL)</div>
        <input class="sp-input" id="cfg-away-id" placeholder="14 = Man City" type="number"/>
      </div>
      <div class="sp-row">
        <div class="sp-label">Kickoff Date & Time</div>
        <input class="sp-input" id="cfg-kickoff" type="datetime-local"/>
      </div>
      <button class="sp-btn green" onclick="applyMatch()">âœ“ APPLY MATCH</button>

      <div style="margin-top:1rem">
        <div class="sp-label" style="margin-bottom:.4rem">Match State</div>
        <div style="display:flex;gap:.4rem;flex-wrap:wrap">
          <button class="sp-btn amber" style="width:auto;padding:.35rem .8rem" onclick="setMatchState('pre')">PRE</button>
          <button class="sp-btn green" style="width:auto;padding:.35rem .8rem" onclick="setMatchState('live')">LIVE</button>
          <button class="sp-btn blue" style="width:auto;padding:.35rem .8rem" onclick="setMatchState('ht')">HT</button>
          <button class="sp-btn danger" style="width:auto;padding:.35rem .8rem" onclick="setMatchState('ft')">FT</button>
        </div>
      </div>
    </div>

    <!-- â‘¡ SCORE CONTROL -->
    <div class="sp-box">
      <div class="sp-box-title"><span>ğŸ¥…</span> Score Control</div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
        <div style="text-align:center">
          <div class="sp-label" style="text-align:center;margin-bottom:.5rem" id="home-score-lbl">HOME</div>
          <div class="score-ctrl">
            <button class="sc-btn minus" onclick="adjScore('home',-1)">âˆ’</button>
            <div class="sc-num" id="cfg-home-score">0</div>
            <button class="sc-btn plus" onclick="adjScore('home',1)">+</button>
          </div>
        </div>
        <div style="text-align:center">
          <div class="sp-label" style="text-align:center;margin-bottom:.5rem" id="away-score-lbl">AWAY</div>
          <div class="score-ctrl">
            <button class="sc-btn minus" onclick="adjScore('away',-1)">âˆ’</button>
            <div class="sc-num" id="cfg-away-score">0</div>
            <button class="sc-btn plus" onclick="adjScore('away',1)">+</button>
          </div>
        </div>
      </div>

      <div class="sp-row" style="margin-top:1rem">
        <div class="sp-label">Last Scorer</div>
        <input class="sp-input" id="cfg-scorer" placeholder="Player name"/>
      </div>
      <div class="sp-row">
        <div class="sp-label">Minute</div>
        <input class="sp-input" id="cfg-minute" placeholder="45" type="number" style="max-width:100px"/>
      </div>
      <button class="sp-btn green" onclick="applyScore()">âœ“ UPDATE SCORE</button>
    </div>

    <!-- â‘¢ MY TEAM (FPL) -->
    <div class="sp-box">
      <div class="sp-box-title"><span>âš¡</span> My Team (FPL)</div>

      <div class="sp-row">
        <div class="sp-label">FPL Team ID</div>
        <input class="sp-input" id="cfg-team-id" placeholder="e.g. 299869" type="number"/>
      </div>
      <button class="sp-btn blue" onclick="loadFPLData()">â†“ LOAD FROM FPL API</button>

      <div class="sp-status" id="fpl-status" style="margin-top:.75rem">
        <div class="ssdot warn"></div>
        <span>Team ID á€‘á€Šá€·á€ºá€•á€¼á€®á€¸ Load á€”á€¾á€­á€•á€ºá€•á€«</span>
      </div>

      <div style="margin-top:1rem;border-top:1px solid var(--bd);padding-top:1rem">
        <div class="sp-label" style="margin-bottom:.5rem">Manual Override</div>
        <div class="sp-row">
          <div class="sp-label">GW Points</div>
          <input class="sp-input" id="cfg-gw-pts" placeholder="72" type="number"/>
        </div>
        <div class="sp-row">
          <div class="sp-label">Overall Rank</div>
          <input class="sp-input" id="cfg-rank" placeholder="1012345" type="number"/>
        </div>
        <div class="sp-row">
          <div class="sp-label">Captain Name</div>
          <input class="sp-input" id="cfg-cap-name" placeholder="Salah"/>
        </div>
        <div class="sp-row">
          <div class="sp-label">Captain Points</div>
          <input class="sp-input" id="cfg-cap-pts" placeholder="14" type="number"/>
        </div>
        <div class="sp-row">
          <div class="sp-label">Captain Team ID (FPL)</div>
          <input class="sp-input" id="cfg-cap-team" placeholder="12 = Liverpool" type="number"/>
        </div>
        <button class="sp-btn amber" onclick="applyTeamManual()">âœ“ APPLY MANUAL</button>
      </div>
    </div>

    <!-- â‘£ POLL -->
    <div class="sp-box">
      <div class="sp-box-title"><span>ğŸ“Š</span> Poll</div>

      <div class="sp-row">
        <div class="sp-label">Question</div>
        <input class="sp-input" id="cfg-poll-q" placeholder="Who will score first?"/>
      </div>
      <div class="sp-row">
        <div class="sp-label">Option 1</div>
        <input class="sp-input" id="cfg-poll-o1" placeholder="Home" value="Home"/>
      </div>
      <div class="sp-row">
        <div class="sp-label">Option 2</div>
        <input class="sp-input" id="cfg-poll-o2" placeholder="Away" value="Away"/>
      </div>
      <div class="sp-row">
        <div class="sp-label">Option 3</div>
        <input class="sp-input" id="cfg-poll-o3" placeholder="No Goal" value="No Goal"/>
      </div>
      <button class="sp-btn purple" onclick="applyPoll()">âœ“ SET NEW POLL</button>

      <div class="poll-bars-preview" id="poll-preview"></div>

      <div style="margin-top:.75rem;border-top:1px solid var(--bd);padding-top:.75rem">
        <div class="sp-label" style="margin-bottom:.4rem">Quick Vote (Test)</div>
        <div style="display:flex;gap:.4rem">
          <button class="sp-btn blue" style="width:auto;padding:.3rem .6rem" onclick="testVote(0)">+1 Opt1</button>
          <button class="sp-btn danger" style="width:auto;padding:.3rem .6rem" onclick="testVote(1)">+1 Opt2</button>
          <button class="sp-btn amber" style="width:auto;padding:.3rem .6rem" onclick="testVote(2)">+1 Opt3</button>
        </div>
      </div>
    </div>

    <!-- â‘¤ VISIBILITY -->
    <div class="sp-box">
      <div class="sp-box-title"><span>ğŸ‘ï¸</span> Visibility</div>

      <div class="sp-toggle-row">
        <span class="sp-toggle-lbl">Score Ticker</span>
        <button class="toggle on" id="tog-ticker" onclick="toggleWidget('ticker')"></button>
      </div>
      <div class="sp-toggle-row">
        <span class="sp-toggle-lbl">Countdown</span>
        <button class="toggle on" id="tog-countdown" onclick="toggleWidget('countdown')"></button>
      </div>
      <div class="sp-toggle-row">
        <span class="sp-toggle-lbl">Match Score</span>
        <button class="toggle on" id="tog-match" onclick="toggleWidget('match')"></button>
      </div>
      <div class="sp-toggle-row">
        <span class="sp-toggle-lbl">My Team Stats</span>
        <button class="toggle on" id="tog-myteam" onclick="toggleWidget('myteam')"></button>
      </div>
      <div class="sp-toggle-row">
        <span class="sp-toggle-lbl">Captain</span>
        <button class="toggle on" id="tog-captain" onclick="toggleWidget('captain')"></button>
      </div>
      <div class="sp-toggle-row">
        <span class="sp-toggle-lbl">Hot Player</span>
        <button class="toggle on" id="tog-hot" onclick="toggleWidget('hot')"></button>
      </div>
      <div class="sp-toggle-row">
        <span class="sp-toggle-lbl">Prediction</span>
        <button class="toggle on" id="tog-predict" onclick="toggleWidget('predict')"></button>
      </div>
      <div class="sp-toggle-row">
        <span class="sp-toggle-lbl">Poll</span>
        <button class="toggle on" id="tog-poll" onclick="toggleWidget('poll')"></button>
      </div>

      <button class="sp-btn danger" style="margin-top:.75rem" onclick="resetAll()">â†º RESET ALL</button>
    </div>

    <!-- â‘¥ OBS URL -->
    <div class="sp-box">
      <div class="sp-box-title"><span>ğŸ®</span> OBS Setup</div>

      <div class="sp-row">
        <div class="sp-label">Your GitHub Username</div>
        <input class="sp-input" id="cfg-username" placeholder="boexaw" oninput="updateURL()"/>
      </div>
      <div class="sp-row">
        <div class="sp-label">Repo Name</div>
        <input class="sp-input" id="cfg-repo" value="livingido-twmm" oninput="updateURL()"/>
      </div>

      <div class="sp-label" style="margin-top:.75rem;margin-bottom:.3rem">OBS Browser Source URL</div>
      <div class="url-box" id="obs-url" onclick="copyURL()">
        https://[username].github.io/livingido-twmm/overlay.html?obs=true
      </div>
      <div class="url-copy-hint">ğŸ‘† Click to copy</div>

      <div style="margin-top:1rem;border-top:1px solid var(--bd);padding-top:1rem">
        <div class="sp-label" style="margin-bottom:.4rem">OBS Settings</div>
        <div style="font-family:var(--fm);font-size:.65rem;color:var(--mt);line-height:1.9">
          Width: <span style="color:var(--ac)">1920</span><br>
          Height: <span style="color:var(--ac)">1080</span><br>
          FPS: <span style="color:var(--ac)">30</span><br>
          Custom CSS: <span style="color:var(--ac)">body{background:rgba(0,0,0,0)!important}</span>
        </div>
      </div>

      <div style="margin-top:1rem;border-top:1px solid var(--bd);padding-top:1rem">
        <div class="sp-label" style="margin-bottom:.4rem">Refresh Rate</div>
        <select class="sp-input" id="cfg-refresh" onchange="applyRefresh()">
          <option value="30000">30 seconds</option>
          <option value="60000" selected>1 minute</option>
          <option value="120000">2 minutes</option>
          <option value="300000">5 minutes</option>
        </select>
      </div>

      <div class="sp-status" style="margin-top:.75rem" id="cache-status">
        <div class="ssdot warn"></div>
        <span>cache.json status unknown</span>
      </div>
    </div>

  </div><!-- /sp-grid -->
</div><!-- /settings-panel -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="overlay-root">

  <!-- Top Strip -->
  <div id="top-strip">

    <!-- Ticker -->
    <div class="ticker-wrap" id="widget-ticker">
      <div class="ticker-label">GW SCORES</div>
      <div class="ticker-track">
        <div class="ticker-inner" id="tickerInner"></div>
      </div>
    </div>

    <!-- Countdown -->
    <div class="countdown-widget" id="widget-countdown">
      <div class="cd-dot" id="cd-dot"></div>
      <div class="cd-label">KICK OFF</div>
      <div class="cd-time" id="cdTime">--:--:--</div>
    </div>

  </div>

  <!-- Main Bar -->
  <div id="main-bar">

    <!-- Brand -->
    <div class="seg-brand">
      <div>
        <div class="brand-txt">FPL<span>HUB</span></div>
        <div class="brand-gw" id="gwLabel">GW â€”</div>
      </div>
    </div>
    <div class="bar-div"></div>

    <!-- Match Score -->
    <div class="seg-match" id="widget-match">
      <div class="match-team">
        <div id="home-badge-wrap"></div>
        <div class="match-team-name" id="match-home-name">HOME</div>
      </div>
      <div>
        <div class="match-scoreboard">
          <div class="match-score-num home" id="match-home-score">0</div>
          <div class="match-score-sep"></div>
          <div class="match-score-num away" id="match-away-score">0</div>
        </div>
        <div style="text-align:center;margin-top:2px">
          <span class="match-state-badge pre" id="match-state-badge">PRE</span>
        </div>
      </div>
      <div class="match-team" style="flex-direction:row-reverse">
        <div id="away-badge-wrap"></div>
        <div class="match-team-name" id="match-away-name">AWAY</div>
      </div>
    </div>
    <div class="bar-div"></div>

    <!-- My Team -->
    <div class="seg-myteam" id="widget-myteam">
      <div class="myteam-lbl">MY TEAM</div>
      <div class="myteam-stats">
        <div class="mt-stat">
          <div class="mt-val pts" id="ob-pts">â€”</div>
          <div class="mt-key">GW PTS</div>
        </div>
        <div class="mt-sep"></div>
        <div class="mt-stat">
          <div class="mt-val rank" id="ob-rank">â€”</div>
          <div class="mt-key">RANK</div>
        </div>
      </div>
    </div>
    <div class="bar-div"></div>

    <!-- Captain -->
    <div class="seg-captain" id="widget-captain">
      <div class="cap-kit-wrap">
        <img class="cap-kit" id="cap-kit-img" src="" alt="" onerror="this.style.display='none'"/>
        <div class="cap-c-badge">C</div>
      </div>
      <div class="cap-info">
        <div class="cap-label">Captain</div>
        <div class="cap-name" id="ob-cap-name">â€”</div>
        <div class="cap-pts" id="ob-cap-pts">â€” pts (Ã—2)</div>
      </div>
    </div>
    <div class="bar-div"></div>

    <!-- Hot Player -->
    <div class="seg-hot" id="widget-hot">
      <img class="hot-kit" id="hot-kit-img" src="" alt="" onerror="this.style.display='none'"/>
      <div class="hot-info">
        <div class="hot-label">ğŸ”¥ Hot Player</div>
        <div class="hot-name" id="ob-hot-name">â€”</div>
        <div class="hot-meta">
          <span class="hot-form" id="ob-hot-form">Form â€”</span>
          <span class="hot-price" id="ob-hot-price">Â£â€”m</span>
          <span class="fdr-p" id="ob-hot-fdr"></span>
        </div>
      </div>
    </div>
    <div class="bar-div"></div>

    <!-- Prediction -->
    <div class="seg-predict" id="widget-predict">
      <div class="pred-label">PRED</div>
      <div class="pred-match">
        <span class="pred-team" id="ob-pred-home">â€”</span>
        <div class="pred-score-box">
          <span class="pred-score p" id="ob-pred-hs">?</span>
          <span class="pred-vs">:</span>
          <span class="pred-score p" id="ob-pred-as">?</span>
        </div>
        <span style="font-size:.55rem;color:rgba(255,255,255,.18)">vs</span>
        <div class="pred-score-box">
          <span class="pred-score a" id="ob-act-hs">?</span>
          <span class="pred-vs">:</span>
          <span class="pred-score a" id="ob-act-as">?</span>
        </div>
        <span class="pred-team" id="ob-pred-away">â€”</span>
        <div class="pred-divider"></div>
        <span class="pred-result pending" id="ob-pred-result">LIVE</span>
      </div>
    </div>
    <div class="bar-div"></div>

    <!-- Poll -->
    <div class="seg-poll" id="widget-poll">
      <div class="poll-info">
        <div class="poll-q" id="ob-poll-q">Community Poll</div>
        <div class="poll-bars" id="ob-poll-bars"></div>
      </div>
    </div>

  </div><!-- /main-bar -->
</div><!-- /overlay-root -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MATCH_KEY  = 'fpl_watchalong_match';
const POLL_KEY   = 'fpl_poll_results';
const PRED_KEY   = 'fpl_predictions';
const OVL_KEY    = 'fpl_overlay_cfg';
const CACHE_URL  = '../data/cache.json';
const FPL_BASE   = 'https://fantasy.premierleague.com/api';
const PROXIES    = ['https://corsproxy.io/?','https://api.allorigins.win/raw?url='];

// Badge/kit URL
const BADGE_URL  = code=>`https://resources.premierleague.com/premierleague/badges/t${code}.png`;
const KIT_URL    = (code,gk)=>`https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${code}${gk?'_1':''}-110.png`;

// FPL team id â†’ badge code
const TEAM_BADGE = {1:3,2:7,3:91,4:94,5:36,6:8,7:31,8:11,9:54,10:40,11:13,12:14,14:43,15:1,16:4,17:17,19:20,20:6,21:21,22:39};
const POS_MAP    = {1:'GKP',2:'DEF',3:'MID',4:'FWD'};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cfg = JSON.parse(localStorage.getItem(OVL_KEY)||'{}');
let matchState = JSON.parse(localStorage.getItem(MATCH_KEY)||'null') || {
  homeTeam:'Home',awayTeam:'Away',homeScore:0,awayScore:0,
  homeId:0,awayId:0,matchState:'pre',gw:28,kickoff:null,goals:[],
};
let pollState = JSON.parse(localStorage.getItem(POLL_KEY)||'null') || {
  question:'Community Poll',options:['Home','Away','Draw'],votes:[0,0,0],myVote:null
};
let widgetVis = cfg.widgets || {ticker:true,countdown:true,match:true,myteam:true,captain:true,hot:true,predict:true,poll:true};
let refreshMs = cfg.refreshMs || 60000;
let countdownInt, refreshInt;
let allPlayers={}, allTeams={};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OBS / PREVIEW MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkMode(){
  const p=new URLSearchParams(location.search);
  if(p.get('obs')==='true'){
    document.body.style.background='transparent';
  } else {
    document.body.classList.add('preview-mode');
  }
  const ko=p.get('kickoff');
  if(ko){ matchState.kickoff=ko; localStorage.setItem(MATCH_KEY,JSON.stringify(matchState)); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSettings(){
  document.getElementById('settings-panel').classList.toggle('open');
  if(document.getElementById('settings-panel').classList.contains('open')){
    loadSettingsInputs();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BADGE / KIT HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeBadge(teamId, size=28){
  const code=TEAM_BADGE[teamId];
  if(!code){
    const d=document.createElement('div');d.className='match-badge-fb';d.style.width=size+'px';d.style.height=size+'px';d.textContent='âš½';return d;
  }
  const img=document.createElement('img');img.className='match-badge';
  img.style.width=size+'px';img.style.height=size+'px';img.src=BADGE_URL(code);
  img.onerror=function(){const d=document.createElement('div');d.className='match-badge-fb';d.style.width=size+'px';d.style.height=size+'px';d.textContent='âš½';this.parentNode&&this.parentNode.replaceChild(d,this);};
  return img;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER MATCH BADGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMatchBadges(){
  const hw=document.getElementById('home-badge-wrap');
  const aw=document.getElementById('away-badge-wrap');
  hw.innerHTML=''; aw.innerHTML='';
  hw.appendChild(makeBadge(matchState.homeId,28));
  aw.appendChild(makeBadge(matchState.awayId,28));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER MATCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMatch(){
  document.getElementById('match-home-name').textContent=matchState.homeTeam||'Home';
  document.getElementById('match-away-name').textContent=matchState.awayTeam||'Away';
  document.getElementById('match-home-score').textContent=matchState.homeScore||0;
  document.getElementById('match-away-score').textContent=matchState.awayScore||0;
  document.getElementById('gwLabel').textContent=`GW ${matchState.gw||'â€”'}`;
  renderMatchBadges();

  const badge=document.getElementById('match-state-badge');
  const ms=matchState.matchState||'pre';
  badge.className='match-state-badge '+ms;
  badge.textContent=ms==='live'?`${matchState.liveMinute||1}'`:ms.toUpperCase();

  // Sync score ctrl display
  document.getElementById('cfg-home-score').textContent=matchState.homeScore||0;
  document.getElementById('cfg-away-score').textContent=matchState.awayScore||0;
  document.getElementById('home-score-lbl').textContent=(matchState.homeTeam||'HOME').toUpperCase().slice(0,8);
  document.getElementById('away-score-lbl').textContent=(matchState.awayTeam||'AWAY').toUpperCase().slice(0,8);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COUNTDOWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startCountdown(){
  clearInterval(countdownInt);
  const el=document.getElementById('cdTime');
  const dot=document.getElementById('cd-dot');
  if(!matchState.kickoff){el.textContent='--:--:--';return;}
  function tick(){
    const diff=new Date(matchState.kickoff).getTime()-Date.now();
    if(diff<=0){el.textContent='LIVE NOW';el.style.color='var(--dg)';dot.style.display='';return;}
    dot.style.display='none';
    const h=Math.floor(diff/3600000);
    const m=Math.floor((diff%3600000)/60000);
    const s=Math.floor((diff%60000)/1000);
    el.textContent=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    el.style.color='var(--am)';
  }
  tick(); countdownInt=setInterval(tick,1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER TICKER from cache
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTicker(fixtures){
  if(!fixtures||!fixtures.length){
    document.getElementById('tickerInner').innerHTML='<div class="ticker-item" style="color:var(--mt)">No fixtures loaded</div>';
    return;
  }
  const makeItems=()=>fixtures.map(f=>{
    const hasScore=f.homeScore!==null&&f.awayScore!==null;
    const isLive=!f.finished&&hasScore;
    const isFT=f.finished&&hasScore;
    const time=f.kickoff?new Date(f.kickoff).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}):'â€”';
    let scoreHtml;
    if(hasScore){
      const cls=isLive?'live':isFT?'ft':'up';
      scoreHtml=`<span class="t-score ${cls}">${f.homeScore}-${f.awayScore}</span>`;
    }else{
      scoreHtml=`<span style="font-family:var(--fm);font-size:.65rem;color:rgba(255,255,255,.35)">${time}</span>`;
    }
    return `<div class="ticker-item"><span>${f.homeShort||f.homeTeam}</span>${scoreHtml}<span>${f.awayShort||f.awayTeam}</span></div>`;
  }).join('');
  const inner=document.getElementById('tickerInner');
  inner.innerHTML=makeItems()+makeItems();
  requestAnimationFrame(()=>{
    const half=inner.scrollWidth/2;
    inner.style.animationDuration=`${Math.max(20,half/60)}s`;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER TEAM STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTeam(cache){
  const team=cache?.team;
  if(!team) return;
  document.getElementById('ob-pts').textContent=team.gwPoints??'â€”';
  const r=team.overallRank;
  document.getElementById('ob-rank').textContent=r?(r>=1000?Math.round(r/1000)+'K':r):'â€”';

  // Captain
  const cap=team.starters?.find(p=>p.isCaptain);
  if(cap){
    document.getElementById('ob-cap-name').textContent=cap.name;
    document.getElementById('ob-cap-pts').textContent=`${cap.displayPts} pts (Ã—2)`;
    // Kit
    const code=TEAM_BADGE[cap.teamId];
    if(code){
      const img=document.getElementById('cap-kit-img');
      img.src=KIT_URL(code,false); img.style.display='block';
    }
  }

  // Hot player
  const top=cache?.topPlayers?.[0];
  if(top){
    document.getElementById('ob-hot-name').textContent=top.name;
    document.getElementById('ob-hot-form').textContent=`Form ${top.form}`;
    document.getElementById('ob-hot-price').textContent=`Â£${top.price}m`;
    const fdrEl=document.getElementById('ob-hot-fdr');
    fdrEl.className=`fdr-p fdr-${Math.min(5,top.nextFDR||3)}`;
    // Hot kit
    const code=TEAM_BADGE[top.teamId];
    if(code){
      const img=document.getElementById('hot-kit-img');
      img.src=KIT_URL(code,false); img.style.display='block';
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER PREDICTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPrediction(cache){
  const saved=JSON.parse(localStorage.getItem(PRED_KEY)||'{}');
  const fixtures=cache?.fixtures||[];
  const target=fixtures.find(f=>!f.finished&&f.homeScore!==null)||fixtures.find(f=>!f.finished)||fixtures[0];
  if(!target) return;
  const pred=saved[target.id]||{};

  document.getElementById('ob-pred-home').textContent=target.homeShort||target.homeTeam||'â€”';
  document.getElementById('ob-pred-away').textContent=target.awayShort||target.awayTeam||'â€”';
  document.getElementById('ob-pred-hs').textContent=pred.home??'?';
  document.getElementById('ob-pred-as').textContent=pred.away??'?';
  document.getElementById('ob-act-hs').textContent=target.homeScore??'?';
  document.getElementById('ob-act-as').textContent=target.awayScore??'?';

  const res=document.getElementById('ob-pred-result');
  if(target.finished){
    const ok=parseInt(pred.home)===target.homeScore&&parseInt(pred.away)===target.awayScore;
    const okResult=ok||Math.sign(pred.home-pred.away)===Math.sign(target.homeScore-target.awayScore);
    res.textContent=ok?'ğŸ¯ EXACT':okResult?'âœ“ CORRECT':'âœ— WRONG';
    res.className='pred-result '+(ok||okResult?'correct':'wrong');
  }else if(target.homeScore!==null){
    res.textContent='â— LIVE'; res.className='pred-result pending';
  }else{
    res.textContent='UPCOMING'; res.className='pred-result pending';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER POLL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPoll(){
  const fresh=JSON.parse(localStorage.getItem(POLL_KEY)||'null');
  if(fresh) pollState=fresh;
  const p=pollState;
  const total=p.votes.reduce((a,b)=>a+b,0)||1;
  document.getElementById('ob-poll-q').textContent=p.question||'Community Poll';
  const bars=document.getElementById('ob-poll-bars');
  bars.innerHTML=p.options.map((opt,i)=>{
    const pct=Math.round(p.votes[i]/total*100);
    return `<div class="poll-row">
      <span class="poll-opt-lbl">${opt}</span>
      <div class="poll-bar-wrap"><div class="poll-bar-fill c${i}" style="width:${pct}%"></div></div>
      <span class="poll-pct">${pct}%</span>
    </div>`;
  }).join('');
  renderPollPreview();
}

function renderPollPreview(){
  const p=pollState;
  const total=p.votes.reduce((a,b)=>a+b,0)||1;
  const prev=document.getElementById('poll-preview'); if(!prev) return;
  prev.innerHTML=p.options.map((opt,i)=>{
    const pct=Math.round(p.votes[i]/total*100);
    return `<div class="pb-row">
      <span class="pb-lbl">${opt}</span>
      <div class="pb-wrap"><div class="pb-fill c${i}" style="width:${pct}%"></div></div>
      <span class="pb-pct">${pct}%</span>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOAD CACHE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadCache(){
  try{
    const r=await fetch(CACHE_URL+'?t='+Date.now());
    const d=await r.json();
    if(d.currentGW) document.getElementById('gwLabel').textContent=`GW ${d.currentGW}`;
    renderTicker(d.fixtures||[]);
    renderTeam(d);
    renderPrediction(d);
    // Cache status
    document.getElementById('cache-status').innerHTML=`<div class="ssdot ok"></div><span>cache.json OK â€” ${new Date(d.fetchedAt||Date.now()).toLocaleTimeString()}</span>`;
    return d;
  }catch(e){
    document.getElementById('cache-status').innerHTML=`<div class="ssdot err"></div><span>cache.json not found â€” push files first</span>`;
    return null;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadSettingsInputs(){
  document.getElementById('cfg-home').value=matchState.homeTeam||'';
  document.getElementById('cfg-away').value=matchState.awayTeam||'';
  document.getElementById('cfg-home-id').value=matchState.homeId||'';
  document.getElementById('cfg-away-id').value=matchState.awayId||'';
  document.getElementById('cfg-home-score').textContent=matchState.homeScore||0;
  document.getElementById('cfg-away-score').textContent=matchState.awayScore||0;
  document.getElementById('home-score-lbl').textContent=(matchState.homeTeam||'HOME').toUpperCase().slice(0,8);
  document.getElementById('away-score-lbl').textContent=(matchState.awayTeam||'AWAY').toUpperCase().slice(0,8);
  if(matchState.kickoff){
    const d=new Date(matchState.kickoff);
    const local=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
    document.getElementById('cfg-kickoff').value=local;
  }
  document.getElementById('cfg-poll-q').value=pollState.question||'';
  document.getElementById('cfg-poll-o1').value=pollState.options[0]||'';
  document.getElementById('cfg-poll-o2').value=pollState.options[1]||'';
  document.getElementById('cfg-poll-o3').value=pollState.options[2]||'';
  const savedId=localStorage.getItem('fplTeamId');
  if(savedId) document.getElementById('cfg-team-id').value=savedId;
  renderPollPreview();
  Object.keys(widgetVis).forEach(k=>{
    const btn=document.getElementById(`tog-${k}`);
    if(btn){btn.className='toggle '+(widgetVis[k]?'on':'off');}
  });
  const u=cfg.username||'';
  const re=cfg.repo||'livingido-twmm';
  document.getElementById('cfg-username').value=u;
  document.getElementById('cfg-repo').value=re;
  updateURL();
}

function applyMatch(){
  matchState.homeTeam=document.getElementById('cfg-home').value||matchState.homeTeam;
  matchState.awayTeam=document.getElementById('cfg-away').value||matchState.awayTeam;
  matchState.homeId=parseInt(document.getElementById('cfg-home-id').value)||matchState.homeId;
  matchState.awayId=parseInt(document.getElementById('cfg-away-id').value)||matchState.awayId;
  const ko=document.getElementById('cfg-kickoff').value;
  if(ko){ matchState.kickoff=new Date(ko).toISOString(); localStorage.setItem('fpl_kickoff',matchState.kickoff); }
  saveMatchState(); renderMatch(); startCountdown();
  showToast('Match applied!');
}

function applyScore(){
  saveMatchState(); renderMatch(); showToast('Score updated!');
}

function adjScore(team,delta){
  if(team==='home') matchState.homeScore=Math.max(0,(matchState.homeScore||0)+delta);
  else matchState.awayScore=Math.max(0,(matchState.awayScore||0)+delta);
  document.getElementById(`cfg-${team}-score`).textContent=matchState[team+'Score'];
  document.getElementById(`match-${team}-score`).textContent=matchState[team+'Score'];
  saveMatchState();
}

function setMatchState(s){
  matchState.matchState=s;
  if(s==='live'&&!matchState.liveMinute) matchState.liveMinute=1;
  saveMatchState(); renderMatch(); showToast(`State: ${s.toUpperCase()}`);
}

function saveMatchState(){ localStorage.setItem(MATCH_KEY,JSON.stringify(matchState)); }

// FPL API Load
async function loadFPLData(){
  const id=document.getElementById('cfg-team-id').value.trim();
  if(!id) return;
  const statusEl=document.getElementById('fpl-status');
  statusEl.innerHTML='<div class="ssdot warn"></div><span>Loadingâ€¦</span>';
  try{
    // Bootstrap
    const boot=await fplFetch('/bootstrap-static/');
    boot.elements.forEach(p=>{allPlayers[p.id]=p;});
    boot.teams.forEach(t=>{allTeams[t.id]=t;});
    // Entry
    const entry=await fplFetch(`/entry/${id}/`);
    const gw=entry.current_event;
    const picks=await fplFetch(`/entry/${id}/event/${gw}/picks/`);
    // Update overlay data
    matchState.gw=gw;
    document.getElementById('ob-pts').textContent=picks.entry_history?.points||0;
    const r=entry.summary_overall_rank;
    document.getElementById('ob-rank').textContent=r?(r>=1000?Math.round(r/1000)+'K':r):'â€”';
    // Captain
    const capPick=picks.picks.find(p=>p.is_captain);
    if(capPick){
      const pl=allPlayers[capPick.element];
      if(pl){
        document.getElementById('ob-cap-name').textContent=pl.web_name;
        document.getElementById('ob-cap-pts').textContent=`${pl.event_points*2} pts (Ã—2)`;
        const tc=allTeams[pl.team];
        if(tc){
          const code=TEAM_BADGE[pl.team];
          if(code){document.getElementById('cap-kit-img').src=KIT_URL(code,false);document.getElementById('cap-kit-img').style.display='block';}
        }
        // Manual fields
        document.getElementById('cfg-cap-name').value=pl.web_name;
        document.getElementById('cfg-cap-pts').value=pl.event_points*2;
        document.getElementById('cfg-cap-team').value=pl.team;
      }
    }
    document.getElementById('cfg-gw-pts').value=picks.entry_history?.points||0;
    document.getElementById('cfg-rank').value=entry.summary_overall_rank||0;
    localStorage.setItem('fplTeamId',id);
    statusEl.innerHTML=`<div class="ssdot ok"></div><span>âœ“ ${entry.name} Â· GW${gw} loaded</span>`;
    saveMatchState();
    showToast('FPL data loaded!');
  }catch(e){
    statusEl.innerHTML=`<div class="ssdot err"></div><span>Failed: ${e.message}</span>`;
  }
}
async function fplFetch(path){
  const url=FPL_BASE+path;
  for(const p of PROXIES){try{const r=await fetch(p+encodeURIComponent(url));if(r.ok)return r.json();}catch(e){}}
  throw new Error('All proxies failed');
}

function applyTeamManual(){
  const pts=document.getElementById('cfg-gw-pts').value;
  const rank=document.getElementById('cfg-rank').value;
  const capName=document.getElementById('cfg-cap-name').value;
  const capPts=document.getElementById('cfg-cap-pts').value;
  const capTeam=parseInt(document.getElementById('cfg-cap-team').value)||0;
  if(pts) document.getElementById('ob-pts').textContent=pts;
  if(rank){const r=parseInt(rank);document.getElementById('ob-rank').textContent=r>=1000?Math.round(r/1000)+'K':r;}
  if(capName) document.getElementById('ob-cap-name').textContent=capName;
  if(capPts) document.getElementById('ob-cap-pts').textContent=`${capPts} pts (Ã—2)`;
  if(capTeam){
    const code=TEAM_BADGE[capTeam];
    if(code){document.getElementById('cap-kit-img').src=KIT_URL(code,false);document.getElementById('cap-kit-img').style.display='block';}
  }
  showToast('Team applied!');
}

function applyPoll(){
  pollState={
    question:document.getElementById('cfg-poll-q').value||'Community Poll',
    options:[
      document.getElementById('cfg-poll-o1').value||'Opt1',
      document.getElementById('cfg-poll-o2').value||'Opt2',
      document.getElementById('cfg-poll-o3').value||'Opt3',
    ],
    votes:[0,0,0],myVote:null,
  };
  localStorage.setItem(POLL_KEY,JSON.stringify(pollState));
  renderPoll(); showToast('Poll reset!');
}
function testVote(i){ pollState.votes[i]++; localStorage.setItem(POLL_KEY,JSON.stringify(pollState)); renderPoll(); }

// Visibility toggles
function toggleWidget(key){
  widgetVis[key]=!widgetVis[key];
  const btn=document.getElementById(`tog-${key}`);
  btn.className='toggle '+(widgetVis[key]?'on':'off');
  const idMap={ticker:'widget-ticker',countdown:'widget-countdown',match:'widget-match',myteam:'widget-myteam',captain:'widget-captain',hot:'widget-hot',predict:'widget-predict',poll:'widget-poll'};
  const el=document.getElementById(idMap[key]);
  if(el) el.style.display=widgetVis[key]?'':'none';
  cfg.widgets=widgetVis; localStorage.setItem(OVL_KEY,JSON.stringify(cfg));
}

function applyRefresh(){
  refreshMs=parseInt(document.getElementById('cfg-refresh').value)||60000;
  cfg.refreshMs=refreshMs; localStorage.setItem(OVL_KEY,JSON.stringify(cfg));
  clearInterval(refreshInt); refreshInt=setInterval(refresh,refreshMs);
  showToast('Refresh updated!');
}

function updateURL(){
  const u=document.getElementById('cfg-username').value.trim()||'[username]';
  const re=document.getElementById('cfg-repo').value.trim()||'livingido-twmm';
  cfg.username=u; cfg.repo=re; localStorage.setItem(OVL_KEY,JSON.stringify(cfg));
  const url=`https://${u}.github.io/${re}/overlay.html?obs=true`;
  document.getElementById('obs-url').textContent=url;
}
function copyURL(){
  const url=document.getElementById('obs-url').textContent;
  navigator.clipboard.writeText(url).then(()=>showToast('URL copied!'));
}

function resetAll(){
  if(!confirm('Reset all overlay settings?')) return;
  localStorage.removeItem(OVL_KEY);
  localStorage.removeItem(MATCH_KEY);
  localStorage.removeItem(POLL_KEY);
  location.reload();
}

// Toast
function showToast(msg){
  let t=document.getElementById('toast');
  if(!t){t=document.createElement('div');t.id='toast';t.style.cssText='position:fixed;top:80px;right:20px;z-index:9999;font-family:var(--fm);font-size:.72rem;padding:.5rem 1rem;border-radius:8px;background:var(--ac);color:#000;font-weight:700;transition:opacity .3s;pointer-events:none';document.body.appendChild(t);}
  t.textContent=msg;t.style.opacity='1';
  clearTimeout(t._timer);t._timer=setTimeout(()=>{t.style.opacity='0';},2000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REFRESH LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function refresh(){
  // Re-read match state from watchalong
  const freshMatch=JSON.parse(localStorage.getItem(MATCH_KEY)||'null');
  if(freshMatch){ matchState=freshMatch; renderMatch(); startCountdown(); }
  // Re-read poll
  renderPoll();
  // Re-read cache
  await loadCache();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  checkMode();
  // Apply saved visibility
  Object.keys(widgetVis).forEach(k=>{
    if(!widgetVis[k]){
      const idMap={ticker:'widget-ticker',countdown:'widget-countdown',match:'widget-match',myteam:'widget-myteam',captain:'widget-captain',hot:'widget-hot',predict:'widget-predict',poll:'widget-poll'};
      const el=document.getElementById(idMap[k]);
      if(el) el.style.display='none';
    }
  });
  renderMatch();
  startCountdown();
  renderPoll();
  await loadCache();
  // Start loops
  setInterval(()=>{
    const fm=JSON.parse(localStorage.getItem(MATCH_KEY)||'null');
    if(fm){matchState=fm;renderMatch();startCountdown();}
    renderPoll();
  },5000);
  refreshInt=setInterval(refresh, refreshMs);
}

init();
</script>
</body>
</html>
