<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>FPL Overlay ‚Äî OBS</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg:#080c14;--s1:#0d1220;--s2:#111827;--s3:#162033;
      --bd:#1a2840;--ac:#00d4aa;--bl:#3b82f6;--am:#f59e0b;
      --dg:#ef4444;--pu:#a855f7;--tx:#e2e8f0;--mt:#4a5f7a;
      --fh:'Bebas Neue',sans-serif;
      --fb:'DM Sans',sans-serif;
      --fm:'JetBrains Mono',monospace;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html,body{width:1920px;height:1080px;background:transparent;overflow:hidden;font-family:var(--fb)}
    body.preview{background:rgba(0,0,0,.88)}

    /* ‚ïê‚ïê‚ïê SETTINGS PANEL ‚ïê‚ïê‚ïê */
    #sp{position:fixed;inset:0;bottom:88px;background:var(--bg);z-index:999;overflow-y:auto;padding:1.5rem 2rem;display:none}
    #sp.open{display:block}
    .sp-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--bd)}
    .sp-ttl{font-family:var(--fh);font-size:2.2rem;letter-spacing:3px;color:var(--ac)}
    .sp-sync{display:flex;align-items:center;gap:.6rem;font-family:var(--fm);font-size:.68rem}
    .sync-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
    .sync-dot.ok{background:var(--ac)}.sync-dot.err{background:var(--dg)}.sync-dot.busy{background:var(--am);animation:pulse 1s infinite}
    .sp-close{font-family:var(--fm);font-size:.65rem;letter-spacing:1px;padding:.4rem 1rem;border-radius:7px;border:1px solid var(--bd);background:transparent;color:var(--mt);cursor:pointer;transition:all .2s}
    .sp-close:hover{border-color:var(--dg);color:var(--dg)}

    .sp-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1.25rem}
    .sp-box{background:var(--s1);border:1px solid var(--bd);border-radius:12px;padding:1.25rem}
    .sp-box-ttl{font-family:var(--fh);font-size:1rem;letter-spacing:2px;margin-bottom:1rem;color:var(--ac)}
    .sp-row{display:flex;flex-direction:column;gap:.25rem;margin-bottom:.75rem}
    .sp-row:last-child{margin-bottom:0}
    .sp-lbl{font-family:var(--fm);font-size:.58rem;color:var(--mt);letter-spacing:1px;text-transform:uppercase}
    .sp-inp{background:var(--s2);border:1px solid var(--bd);border-radius:6px;padding:.4rem .7rem;color:var(--tx);font-family:var(--fm);font-size:.78rem;outline:none;transition:border-color .2s;width:100%}
    .sp-inp:focus{border-color:var(--ac)}
    .sp-inp::placeholder{color:var(--mt);font-size:.7rem}
    .sp-inp.token-inp{letter-spacing:1px;color:var(--am)}
    select.sp-inp{cursor:pointer}

    .sb{font-family:var(--fm);font-size:.65rem;letter-spacing:1px;padding:.4rem .9rem;border-radius:6px;border:none;cursor:pointer;transition:all .2s;font-weight:700;width:100%;margin-top:.2rem}
    .sb.g{background:rgba(0,212,170,.15);color:var(--ac);border:1px solid rgba(0,212,170,.3)}.sb.g:hover{background:var(--ac);color:#000}
    .sb.b{background:rgba(59,130,246,.15);color:var(--bl);border:1px solid rgba(59,130,246,.3)}.sb.b:hover{background:var(--bl);color:#fff}
    .sb.a{background:rgba(245,158,11,.15);color:var(--am);border:1px solid rgba(245,158,11,.3)}.sb.a:hover{background:var(--am);color:#000}
    .sb.d{background:rgba(239,68,68,.15);color:var(--dg);border:1px solid rgba(239,68,68,.3)}.sb.d:hover{background:var(--dg);color:#fff}
    .sb.p{background:rgba(168,85,247,.15);color:var(--pu);border:1px solid rgba(168,85,247,.3)}.sb.p:hover{background:var(--pu);color:#fff}
    .sb.sm{width:auto;padding:.3rem .65rem}

    .sc-row{display:flex;align-items:center;justify-content:center;gap:.5rem;margin:.4rem 0}
    .sc-btn{width:30px;height:30px;border-radius:6px;border:none;cursor:pointer;font-size:1rem;transition:all .15s;display:flex;align-items:center;justify-content:center}
    .sc-btn.p{background:rgba(0,212,170,.15);color:var(--ac)}.sc-btn.p:hover{background:var(--ac);color:#000}
    .sc-btn.m{background:rgba(239,68,68,.15);color:var(--dg)}.sc-btn.m:hover{background:var(--dg);color:#fff}
    .sc-num{font-family:var(--fh);font-size:1.8rem;min-width:32px;text-align:center}

    .tog-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:.6rem}
    .tog-lbl{font-size:.78rem;font-weight:600}
    .tog{width:38px;height:20px;border-radius:10px;position:relative;cursor:pointer;border:none;transition:background .2s;flex-shrink:0}
    .tog.on{background:var(--ac)}.tog.off{background:var(--mt)}
    .tog::after{content:'';position:absolute;top:3px;width:14px;height:14px;border-radius:50%;background:#fff;transition:left .2s}
    .tog.on::after{left:21px}.tog.off::after{left:3px}

    .status-row{display:flex;align-items:center;gap:.4rem;font-family:var(--fm);font-size:.62rem;padding:.3rem .65rem;border-radius:8px;background:var(--s2);border:1px solid var(--bd);margin-top:.4rem}
    .sdot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
    .sdot.ok{background:var(--ac)}.sdot.err{background:var(--dg)}.sdot.warn{background:var(--am)}

    .url-box{background:var(--s2);border:1px solid var(--bd);border-radius:6px;padding:.5rem .75rem;font-family:var(--fm);font-size:.6rem;color:var(--ac);word-break:break-all;line-height:1.6;margin-top:.4rem;cursor:pointer;transition:background .2s}
    .url-box:hover{background:rgba(0,212,170,.05)}

    .state-btns{display:flex;gap:.35rem;flex-wrap:wrap;margin-top:.4rem}
    .state-btns .sb{width:auto}

    .poll-prev{display:flex;flex-direction:column;gap:.3rem;margin-top:.5rem}
    .pp-row{display:flex;align-items:center;gap:.4rem}
    .pp-lbl{font-size:.6rem;color:var(--mt);width:50px;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .pp-bar{flex:1;height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden}
    .pp-fill{height:100%;border-radius:3px;transition:width .8s ease}
    .pp-fill.c0{background:var(--bl)}.pp-fill.c1{background:var(--dg)}.pp-fill.c2{background:var(--am)}
    .pp-pct{font-family:var(--fm);font-size:.58rem;color:var(--mt);width:24px;text-align:right}

    /* ‚ïê‚ïê‚ïê SETTINGS BTN ‚ïê‚ïê‚ïê */
    #sp-btn{position:fixed;top:14px;right:16px;z-index:1000;font-family:var(--fm);font-size:.62rem;letter-spacing:1px;padding:.38rem .85rem;border-radius:7px;border:1px solid var(--bd);background:rgba(13,18,32,.95);color:var(--mt);cursor:pointer;transition:all .2s;backdrop-filter:blur(10px)}
    #sp-btn:hover{border-color:var(--ac);color:var(--ac)}
    body:not(.preview) #sp-btn{display:none}

    /* ‚ïê‚ïê‚ïê OVERLAY ‚ïê‚ïê‚ïê */
    #ov{position:absolute;bottom:0;left:0;right:0;display:flex;flex-direction:column;pointer-events:none}

    /* Top strip */
    #top-strip{display:flex;justify-content:space-between;align-items:flex-end;padding:0 20px 5px;gap:10px}
    .ticker-wrap{display:flex;align-items:center;background:rgba(5,8,18,.95);border:1px solid var(--bd);border-bottom:none;border-radius:10px 10px 0 0;overflow:hidden;height:34px;flex:1;max-width:880px}
    .ticker-tag{background:var(--bl);color:#fff;font-family:var(--fh);font-size:.78rem;letter-spacing:2px;padding:0 12px;height:100%;display:flex;align-items:center;white-space:nowrap;flex-shrink:0}
    .ticker-track{overflow:hidden;flex:1;height:100%;position:relative}
    .ticker-inner{display:flex;align-items:center;height:100%;white-space:nowrap;animation:scroll 32s linear infinite}
    .ticker-item{display:inline-flex;align-items:center;gap:6px;padding:0 16px;border-right:1px solid var(--bd);height:100%;font-size:.72rem;font-weight:600}
    .ts{font-family:var(--fm);font-size:.78rem;font-weight:700;padding:1px 6px;border-radius:3px}
    .ts.live{color:var(--dg);background:rgba(239,68,68,.12);animation:pulse 1.5s infinite}
    .ts.ft{color:var(--ac);background:rgba(0,212,170,.1)}
    .ts.up{color:rgba(255,255,255,.35);background:rgba(255,255,255,.05)}
    @keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}

    .cd-widget{background:rgba(5,8,18,.95);border:1px solid var(--bd);border-bottom:none;border-radius:10px 10px 0 0;padding:4px 14px;display:flex;align-items:center;gap:8px;height:34px}
    .cd-lbl{font-family:var(--fm);font-size:.55rem;color:rgba(255,255,255,.3);letter-spacing:2px}
    .cd-val{font-family:var(--fh);font-size:.95rem;color:var(--am);letter-spacing:2px}
    .cd-dot{width:5px;height:5px;border-radius:50%;background:var(--dg);animation:pulse 1s infinite}

    /* Main bar */
    #bar{background:rgba(8,12,20,.95);border-top:2px solid var(--ac);display:flex;align-items:stretch;height:80px}
    .div{width:1px;background:var(--bd);flex-shrink:0}

    .seg-brand{display:flex;align-items:center;padding:0 16px;gap:8px;flex-shrink:0;background:rgba(0,212,170,.04)}
    .brand{font-family:var(--fh);font-size:1.4rem;letter-spacing:3px;color:var(--ac)}
    .brand span{color:var(--tx)}
    .brand-gw{font-family:var(--fm);font-size:.52rem;color:rgba(255,255,255,.28);letter-spacing:2px;margin-top:2px}

    /* Match score seg */
    .seg-match{display:flex;align-items:center;padding:0 14px;gap:10px;flex-shrink:0}
    .mt-team{display:flex;align-items:center;gap:6px}
    .mt-badge{width:26px;height:26px;object-fit:contain;filter:drop-shadow(0 1px 3px rgba(0,0,0,.5))}
    .mt-badge-fb{width:26px;height:26px;border-radius:50%;background:var(--s2);border:1px solid var(--bd);display:flex;align-items:center;justify-content:center;font-size:.75rem}
    .mt-name{font-family:var(--fh);font-size:.82rem;letter-spacing:1px}
    .scoreboard{display:flex;align-items:center;background:var(--s2);border:1px solid var(--bd);border-radius:7px;overflow:hidden}
    .sn{font-family:var(--fh);font-size:1.7rem;letter-spacing:1px;padding:0 10px;min-width:42px;text-align:center}
    .sn.h{color:var(--ac)}.sn.a{color:var(--bl)}
    .sdiv{width:1px;height:38px;background:var(--bd)}
    .state-badge{font-family:var(--fm);font-size:.52rem;padding:2px 6px;border-radius:8px;margin-left:4px}
    .state-badge.live{background:rgba(239,68,68,.15);color:var(--dg);border:1px solid rgba(239,68,68,.3);animation:pulse 2s infinite}
    .state-badge.ht{background:rgba(245,158,11,.12);color:var(--am);border:1px solid rgba(245,158,11,.2)}
    .state-badge.ft{background:rgba(0,212,170,.1);color:var(--ac);border:1px solid rgba(0,212,170,.2)}
    .state-badge.pre{background:rgba(255,255,255,.05);color:var(--mt);border:1px solid var(--bd)}

    /* Team stats */
    .seg-team{display:flex;align-items:center;padding:0 14px;gap:12px;flex-shrink:0}
    .team-lbl{font-family:var(--fm);font-size:.55rem;color:rgba(255,255,255,.25);writing-mode:vertical-rl;transform:rotate(180deg)}
    .team-stats{display:flex;gap:10px;align-items:center}
    .ts-stat{text-align:center}
    .ts-val{font-family:var(--fh);font-size:1.4rem;letter-spacing:1px;line-height:1}
    .ts-val.pts{color:var(--ac)}.ts-val.rnk{color:var(--bl)}
    .ts-key{font-size:.52rem;color:rgba(255,255,255,.28);text-transform:uppercase;letter-spacing:1.5px;margin-top:2px}
    .ts-sep{width:1px;height:30px;background:var(--bd)}

    /* Captain */
    .seg-cap{display:flex;align-items:center;padding:0 14px;gap:9px;flex-shrink:0}
    .cap-wrap{position:relative;flex-shrink:0}
    .cap-kit{width:46px;height:46px;object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,.5))}
    .cap-badge{position:absolute;bottom:-2px;right:-2px;width:15px;height:15px;border-radius:50%;background:var(--am);color:#000;font-family:var(--fh);font-size:.52rem;display:flex;align-items:center;justify-content:center;border:1.5px solid rgba(8,12,20,.95)}
    .cap-info .lbl{font-size:.52rem;color:rgba(255,255,255,.28);letter-spacing:2px;text-transform:uppercase}
    .cap-name{font-family:var(--fh);font-size:.95rem;letter-spacing:1px;line-height:1.1}
    .cap-pts{font-family:var(--fm);font-size:.65rem;color:var(--am)}

    /* Hot */
    .seg-hot{display:flex;align-items:center;padding:0 12px;gap:9px;flex-shrink:0;background:rgba(245,158,11,.02)}
    .hot-kit{width:42px;height:42px;object-fit:contain;filter:drop-shadow(0 1px 3px rgba(0,0,0,.4))}
    .hot-lbl{font-size:.52rem;color:rgba(255,255,255,.28);letter-spacing:2px;text-transform:uppercase}
    .hot-name{font-family:var(--fh);font-size:.9rem;letter-spacing:1px;line-height:1.1}
    .hot-meta{display:flex;gap:5px;align-items:center;margin-top:2px}
    .hot-form{font-family:var(--fm);font-size:.62rem;color:var(--am)}
    .hot-price{font-family:var(--fm);font-size:.62rem;color:rgba(255,255,255,.3)}
    .fdr-p{display:inline-block;width:6px;height:6px;border-radius:2px}
    .fdr-1,.fdr-2{background:var(--ac)}.fdr-3{background:var(--am)}.fdr-4,.fdr-5{background:var(--dg)}

    /* Prediction */
    .seg-pred{display:flex;align-items:center;padding:0 12px;gap:10px;flex:1}
    .pred-lbl{font-size:.52rem;color:rgba(255,255,255,.28);letter-spacing:2px;text-transform:uppercase;white-space:nowrap}
    .pred-body{display:flex;align-items:center;gap:7px}
    .pred-team{font-family:var(--fh);font-size:.88rem;letter-spacing:1px}
    .pred-sbox{display:flex;align-items:center;gap:3px}
    .pred-s{font-family:var(--fm);font-size:.9rem;font-weight:700;width:22px;height:22px;border-radius:4px;display:flex;align-items:center;justify-content:center}
    .pred-s.p{color:var(--bl);background:rgba(59,130,246,.12)}
    .pred-s.a{color:var(--ac);background:rgba(0,212,170,.1)}
    .pred-vs{font-family:var(--fm);font-size:.55rem;color:rgba(255,255,255,.2)}
    .pred-rdiv{width:1px;height:26px;background:var(--bd)}
    .pred-res{font-family:var(--fm);font-size:.58rem;padding:2px 6px;border-radius:4px}
    .pred-res.correct{background:rgba(0,212,170,.15);color:var(--ac)}
    .pred-res.wrong{background:rgba(239,68,68,.15);color:var(--dg)}
    .pred-res.pending{background:rgba(245,158,11,.1);color:var(--am)}

    /* Poll */
    .seg-poll{display:flex;align-items:center;padding:0 12px;gap:10px;flex-shrink:0;background:rgba(168,85,247,.02)}
    .poll-q{font-size:.58rem;color:rgba(255,255,255,.4);max-width:140px;line-height:1.3}
    .poll-bars{display:flex;flex-direction:column;gap:3px;min-width:130px}
    .pb-row{display:flex;align-items:center;gap:4px}
    .pb-lbl{font-size:.54rem;color:rgba(255,255,255,.3);width:24px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex-shrink:0}
    .pb-wrap{flex:1;height:5px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden}
    .pb-fill{height:100%;border-radius:3px;transition:width 1s ease}
    .pb-fill.c0{background:var(--bl)}.pb-fill.c1{background:var(--dg)}.pb-fill.c2{background:var(--am)}
    .pb-pct{font-family:var(--fm);font-size:.55rem;color:rgba(255,255,255,.35);width:24px;text-align:right}

    /* Toast */
    #toast{position:fixed;top:70px;right:16px;z-index:9999;font-family:var(--fm);font-size:.7rem;padding:.45rem 1rem;border-radius:7px;background:var(--ac);color:#000;font-weight:700;opacity:0;transition:opacity .3s;pointer-events:none}

    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    #ov{animation:slideUp .5s ease forwards}
  </style>
</head>
<body>

<div id="toast"></div>
<button id="sp-btn" onclick="toggleSP()">‚öôÔ∏è OVERLAY SETTINGS</button>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="sp">
  <div class="sp-hdr">
    <div class="sp-ttl">‚öôÔ∏è OVERLAY SETTINGS</div>
    <div class="sp-sync">
      <div class="sync-dot warn" id="sync-dot"></div>
      <span id="sync-txt">Not synced</span>
    </div>
    <button class="sp-close" onclick="toggleSP()">‚úï CLOSE</button>
  </div>

  <div class="sp-grid">

    <!-- ‚ë† GitHub Sync -->
    <div class="sp-box">
      <div class="sp-box-ttl">üîë GitHub Sync</div>
      <div class="sp-row">
        <div class="sp-lbl">Personal Access Token</div>
        <input class="sp-inp token-inp" id="cfg-token" type="password" placeholder="ghp_xxxxxxxxxxxx"/>
        <div style="font-size:.58rem;color:var(--mt);margin-top:3px">Browser ·Äô·Äæ·Ä¨·Äû·Ä¨ ·Äû·Ä≠·Äô·Ä∫·Ä∏·Äû·Ää·Ä∫ ‚Äî GitHub ·Äô·Äê·ÄÑ·Ä∫·Äò·Ä∞·Ä∏</div>
      </div>
      <div class="sp-row">
        <div class="sp-lbl">GitHub Username <span style="color:var(--am);font-size:.55rem;font-style:normal">(username ·Äê·Ää·Ä∫·Ä∏ ‚ùå .github.io ·Äô·Äë·Ää·Ä∑·Ä∫·Äî·Ä≤·Ä∑)</span></div>
        <input class="sp-inp" id="cfg-user" placeholder="boexaw" oninput="cleanUser(this)"/>
      </div>
      <div class="sp-row">
        <div class="sp-lbl">Repo Name</div>
        <input class="sp-inp" id="cfg-repo" value="livingido-twmm" oninput="updateURL()"/>
      </div>
      <button class="sb g" onclick="testGitHub()">üîó TEST CONNECTION</button>
      <button class="sb b" style="margin-top:.4rem" onclick="pushState()">‚¨Ü PUSH STATE NOW</button>

      <div class="status-row" id="gh-status">
        <div class="sdot warn"></div><span>Token ·Äë·Ää·Ä∑·Ä∫·Äï·Äº·ÄÆ·Ä∏ Test ·Äî·Äæ·Ä≠·Äï·Ä∫·Äï·Ä´</span>
      </div>

      <div class="sp-lbl" style="margin-top:.75rem;margin-bottom:.3rem">OBS URL</div>
      <div class="url-box" id="obs-url" onclick="copyURL()">
        https://[username].github.io/livingido-twmm/overlay.html?obs=true
      </div>
      <div style="font-size:.55rem;color:var(--mt);margin-top:3px">üëÜ Click to copy ¬∑ Token ·Äï·Ä´ OBS URL ·ÄÄ·Ä≠·ÄØ OBS ·Äô·Äæ·Ä¨ ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´</div>
      <div style="font-size:.58rem;color:var(--am);margin-top:4px;font-family:var(--fm)">‚ö† Token ·Äï·Ä´·Äê·Ä≤·Ä∑ URL ·ÄÄ·Ä≠·ÄØ ·Äô·Ää·Ä∫·Äû·Ä∞·Ä∑·Äô·Äæ ·Äô·Äï·Äº·Äî·Ä≤·Ä∑</div>

      <div style="margin-top:.75rem;font-family:var(--fm);font-size:.6rem;color:var(--mt);line-height:1.9">
        OBS Width: <span style="color:var(--ac)">1920</span> ¬∑
        Height: <span style="color:var(--ac)">1080</span><br>
        CSS: <span style="color:var(--ac)">body{background:rgba(0,0,0,0)!important}</span>
      </div>
    </div>

    <!-- ‚ë° Match + Score -->
    <div class="sp-box">
      <div class="sp-box-ttl">‚öΩ Match & Score</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem">
        <div class="sp-row">
          <div class="sp-lbl">Home Team</div>
          <input class="sp-inp" id="cfg-home" placeholder="Arsenal"/>
        </div>
        <div class="sp-row">
          <div class="sp-lbl">Home FPL ID</div>
          <input class="sp-inp" id="cfg-home-id" placeholder="1" type="number"/>
        </div>
        <div class="sp-row">
          <div class="sp-lbl">Away Team</div>
          <input class="sp-inp" id="cfg-away" placeholder="Man City"/>
        </div>
        <div class="sp-row">
          <div class="sp-lbl">Away FPL ID</div>
          <input class="sp-inp" id="cfg-away-id" placeholder="14" type="number"/>
        </div>
      </div>
      <div class="sp-row">
        <div class="sp-lbl">Kickoff Date & Time</div>
        <input class="sp-inp" id="cfg-kickoff" type="datetime-local"/>
      </div>
      <button class="sb g" onclick="applyMatch()">‚úì APPLY MATCH</button>

      <div style="margin-top:.75rem">
        <div class="sp-lbl" style="margin-bottom:.35rem">Score Control</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem">
          <div style="text-align:center">
            <div class="sp-lbl" id="home-ctrl-lbl">HOME</div>
            <div class="sc-row">
              <button class="sc-btn m" onclick="adj('home',-1)">‚àí</button>
              <div class="sc-num" id="ctrl-hs">0</div>
              <button class="sc-btn p" onclick="adj('home',1)">+</button>
            </div>
          </div>
          <div style="text-align:center">
            <div class="sp-lbl" id="away-ctrl-lbl">AWAY</div>
            <div class="sc-row">
              <button class="sc-btn m" onclick="adj('away',-1)">‚àí</button>
              <div class="sc-num" id="ctrl-as">0</div>
              <button class="sc-btn p" onclick="adj('away',1)">+</button>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:.6rem">
        <div class="sp-lbl" style="margin-bottom:.3rem">Match State</div>
        <div class="state-btns">
          <button class="sb a sm" onclick="setState('pre')">PRE</button>
          <button class="sb g sm" onclick="setState('live')">‚ñ∂ LIVE</button>
          <button class="sb b sm" onclick="setState('ht')">HT</button>
          <button class="sb d sm" onclick="setState('ft')">FT</button>
        </div>
      </div>
    </div>

    <!-- ‚ë¢ FPL Team + Poll -->
    <div class="sp-box">
      <div class="sp-box-ttl">‚ö° FPL Team</div>
      <div class="sp-row">
        <div class="sp-lbl">FPL Team ID</div>
        <input class="sp-inp" id="cfg-tid" placeholder="299869" type="number"/>
      </div>
      <button class="sb b" onclick="loadFPL()">‚Üì LOAD FROM API</button>
      <div class="status-row" id="fpl-status"><div class="sdot warn"></div><span>Team ID ·Äë·Ää·Ä∑·Ä∫·Äï·Äº·ÄÆ·Ä∏ Load ·Äî·Äæ·Ä≠·Äï·Ä∫·Äï·Ä´</span></div>

      <div style="margin-top:.9rem;border-top:1px solid var(--bd);padding-top:.9rem">
        <div class="sp-box-ttl" style="margin-bottom:.75rem">üìä Poll</div>
        <div class="sp-row">
          <div class="sp-lbl">Question</div>
          <input class="sp-inp" id="cfg-pq" placeholder="Who scores first?"/>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:.4rem;margin-bottom:.4rem">
          <input class="sp-inp" id="cfg-p1" placeholder="Home" value="Home"/>
          <input class="sp-inp" id="cfg-p2" placeholder="Away" value="Away"/>
          <input class="sp-inp" id="cfg-p3" placeholder="Draw" value="Draw"/>
        </div>
        <button class="sb p" onclick="applyPoll()">‚úì NEW POLL</button>
        <div style="display:flex;gap:.3rem;margin-top:.4rem">
          <button class="sb b sm" onclick="tv(0)">+1 A</button>
          <button class="sb d sm" onclick="tv(1)">+1 B</button>
          <button class="sb a sm" onclick="tv(2)">+1 C</button>
        </div>
        <div class="poll-prev" id="poll-prev"></div>
      </div>
    </div>

    <!-- ‚ë£ Visibility + Refresh -->
    <div class="sp-box">
      <div class="sp-box-ttl">üëÅÔ∏è Widgets</div>
      <div class="tog-row"><span class="tog-lbl">Score Ticker</span><button class="tog on" id="tog-ticker" onclick="togW('ticker')"></button></div>
      <div class="tog-row"><span class="tog-lbl">Countdown</span><button class="tog on" id="tog-countdown" onclick="togW('countdown')"></button></div>
      <div class="tog-row"><span class="tog-lbl">Match Score</span><button class="tog on" id="tog-match" onclick="togW('match')"></button></div>
      <div class="tog-row"><span class="tog-lbl">My Team Stats</span><button class="tog on" id="tog-myteam" onclick="togW('myteam')"></button></div>
      <div class="tog-row"><span class="tog-lbl">Captain</span><button class="tog on" id="tog-cap" onclick="togW('cap')"></button></div>
      <div class="tog-row"><span class="tog-lbl">Hot Player</span><button class="tog on" id="tog-hot" onclick="togW('hot')"></button></div>
      <div class="tog-row"><span class="tog-lbl">Prediction</span><button class="tog on" id="tog-pred" onclick="togW('pred')"></button></div>
      <div class="tog-row"><span class="tog-lbl">Poll</span><button class="tog on" id="tog-poll" onclick="togW('poll')"></button></div>

      <div style="margin-top:.75rem;border-top:1px solid var(--bd);padding-top:.75rem">
        <div class="sp-lbl" style="margin-bottom:.3rem">Auto-Fetch Interval</div>
        <select class="sp-inp" id="cfg-interval" onchange="applyInterval()">
          <option value="5000">5 seconds</option>
          <option value="10000" selected>10 seconds</option>
          <option value="30000">30 seconds</option>
          <option value="60000">1 minute</option>
        </select>
      </div>

      <button class="sb d" style="margin-top:.75rem" onclick="resetAll()">‚Ü∫ RESET ALL</button>
    </div>

  </div>
</div><!-- /sp -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OVERLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="ov">
  <div id="top-strip">
    <div class="ticker-wrap" id="w-ticker">
      <div class="ticker-tag">LIVE SCORES</div>
      <div class="ticker-track"><div class="ticker-inner" id="ticker"></div></div>
    </div>
    <div class="cd-widget" id="w-countdown">
      <div class="cd-dot" id="cd-dot"></div>
      <div class="cd-lbl">KICK OFF</div>
      <div class="cd-val" id="cd-val">--:--:--</div>
    </div>
  </div>

  <div id="bar">
    <div class="seg-brand">
      <div>
        <div class="brand">FPL<span>HUB</span></div>
        <div class="brand-gw" id="gw-lbl">GW ‚Äî</div>
      </div>
    </div>
    <div class="div"></div>

    <div class="seg-match" id="w-match">
      <div class="mt-team">
        <div id="hb-wrap"></div>
        <div class="mt-name" id="ob-hname">HOME</div>
      </div>
      <div>
        <div class="scoreboard">
          <div class="sn h" id="ob-hs">0</div>
          <div class="sdiv"></div>
          <div class="sn a" id="ob-as">0</div>
        </div>
        <div style="text-align:center;margin-top:2px">
          <span class="state-badge pre" id="ob-state">PRE</span>
        </div>
      </div>
      <div class="mt-team" style="flex-direction:row-reverse">
        <div id="ab-wrap"></div>
        <div class="mt-name" id="ob-aname">AWAY</div>
      </div>
    </div>
    <div class="div"></div>

    <div class="seg-team" id="w-myteam">
      <div class="team-lbl">MY TEAM</div>
      <div class="team-stats">
        <div class="ts-stat"><div class="ts-val pts" id="ob-pts">‚Äî</div><div class="ts-key">GW PTS</div></div>
        <div class="ts-sep"></div>
        <div class="ts-stat"><div class="ts-val rnk" id="ob-rank">‚Äî</div><div class="ts-key">RANK</div></div>
      </div>
    </div>
    <div class="div"></div>

    <div class="seg-cap" id="w-cap">
      <div class="cap-wrap">
        <img class="cap-kit" id="ob-cap-kit" src="" alt="" onerror="this.style.display='none'"/>
        <div class="cap-badge">C</div>
      </div>
      <div class="cap-info">
        <div class="lbl">CAPTAIN</div>
        <div class="cap-name" id="ob-cap-name">‚Äî</div>
        <div class="cap-pts" id="ob-cap-pts">‚Äî pts √ó2</div>
      </div>
    </div>
    <div class="div"></div>

    <div class="seg-hot" id="w-hot">
      <img class="hot-kit" id="ob-hot-kit" src="" alt="" onerror="this.style.display='none'"/>
      <div>
        <div class="hot-lbl">üî• HOT PLAYER</div>
        <div class="hot-name" id="ob-hot-name">‚Äî</div>
        <div class="hot-meta">
          <span class="hot-form" id="ob-hot-form">‚Äî</span>
          <span class="hot-price" id="ob-hot-price">‚Äî</span>
          <span class="fdr-p" id="ob-hot-fdr"></span>
        </div>
      </div>
    </div>
    <div class="div"></div>

    <div class="seg-pred" id="w-pred">
      <div class="pred-lbl">PRED</div>
      <div class="pred-body">
        <span class="pred-team" id="ob-ph">‚Äî</span>
        <div class="pred-sbox">
          <span class="pred-s p" id="ob-phs">?</span>
          <span class="pred-vs">:</span>
          <span class="pred-s p" id="ob-pas">?</span>
        </div>
        <span style="font-size:.52rem;color:rgba(255,255,255,.15)">vs</span>
        <div class="pred-sbox">
          <span class="pred-s a" id="ob-ahs">?</span>
          <span class="pred-vs">:</span>
          <span class="pred-s a" id="ob-aas">?</span>
        </div>
        <span class="pred-team" id="ob-pa">‚Äî</span>
        <div class="pred-rdiv"></div>
        <span class="pred-res pending" id="ob-res">‚Äî</span>
      </div>
    </div>
    <div class="div"></div>

    <div class="seg-poll" id="w-poll">
      <div class="poll-q" id="ob-pq">Community Poll</div>
      <div class="poll-bars" id="ob-pbars"></div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê KEYS ‚ïê‚ïê‚ïê
const OVL_KEY  = 'fpl_overlay_cfg';
const POLL_KEY = 'fpl_poll_results';
const PRED_KEY = 'fpl_predictions';
const CACHE    = '../data/cache.json';
const PROXIES  = ['https://corsproxy.io/?','https://api.allorigins.win/raw?url='];
const FPL_API  = 'https://fantasy.premierleague.com/api';
const BADGE    = c=>`https://resources.premierleague.com/premierleague/badges/t${c}.png`;
const KIT      = (c,gk)=>`https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${c}${gk?'_1':''}-110.png`;
const TB       = {1:3,2:7,3:91,4:94,5:36,6:8,7:31,8:11,9:54,10:40,11:13,12:14,14:43,15:1,16:4,17:17,19:20,20:6,21:21,22:39};

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let cfg = JSON.parse(localStorage.getItem(OVL_KEY)||'{}');
let poll = {question:'Community Poll',options:['Home','Away','Draw'],votes:[0,0,0]};
let matchData = {homeTeam:'Home',awayTeam:'Away',homeScore:0,awayScore:0,homeId:0,awayId:0,matchState:'pre',gw:28,kickoff:null};
let widgets = cfg.widgets||{ticker:1,countdown:1,match:1,myteam:1,cap:1,hot:1,pred:1,poll:1};
let fetchInt, cdInt;
let allPlayers={}, allTeams={};

// ‚ïê‚ïê‚ïê MODE ‚ïê‚ïê‚ïê
function checkMode(){
  const p=new URLSearchParams(location.search);
  if(p.get('obs')==='true'){
    document.body.style.background='transparent';
  } else {
    document.body.classList.add('preview');
  }
  // OBS URL params override localStorage cfg
  if(p.get('token')) cfg.token=p.get('token');
  if(p.get('user'))  cfg.user=p.get('user');
  if(p.get('repo'))  cfg.repo=p.get('repo');
  // Auto-detect user from current hostname e.g. boexaw-ship-it.github.io
  if(!cfg.user){
    const host=location.hostname; // e.g. boexaw-ship-it.github.io
    const m=host.match(/^([^.]+)\.github\.io$/);
    if(m) cfg.user=m[1];
  }
}

// ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê
function toggleSP(){
  const sp=document.getElementById('sp');
  sp.classList.toggle('open');
  if(sp.classList.contains('open')) fillInputs();
}
function fillInputs(){
  document.getElementById('cfg-token').value = cfg.token||'';
  document.getElementById('cfg-user').value  = cfg.user||'';
  document.getElementById('cfg-repo').value  = cfg.repo||'livingido-twmm';
  document.getElementById('cfg-home').value  = matchData.homeTeam||'';
  document.getElementById('cfg-away').value  = matchData.awayTeam||'';
  document.getElementById('cfg-home-id').value = matchData.homeId||'';
  document.getElementById('cfg-away-id').value = matchData.awayId||'';
  document.getElementById('ctrl-hs').textContent = matchData.homeScore||0;
  document.getElementById('ctrl-as').textContent = matchData.awayScore||0;
  document.getElementById('home-ctrl-lbl').textContent = (matchData.homeTeam||'HOME').toUpperCase().slice(0,6);
  document.getElementById('away-ctrl-lbl').textContent = (matchData.awayTeam||'AWAY').toUpperCase().slice(0,6);
  if(matchData.kickoff){
    const d=new Date(matchData.kickoff);
    document.getElementById('cfg-kickoff').value=new Date(d-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
  }
  document.getElementById('cfg-pq').value = poll.question||'';
  document.getElementById('cfg-p1').value = poll.options[0]||'';
  document.getElementById('cfg-p2').value = poll.options[1]||'';
  document.getElementById('cfg-p3').value = poll.options[2]||'';
  const savedId=localStorage.getItem('fplTeamId');
  if(savedId) document.getElementById('cfg-tid').value=savedId;
  Object.keys(widgets).forEach(k=>{
    const b=document.getElementById(`tog-${k}`);
    if(b) b.className='tog '+(widgets[k]?'on':'off');
  });
  updateURL();
  renderPollPrev();
}

// ‚ïê‚ïê‚ïê GITHUB API ‚ïê‚ïê‚ïê
function ghHeaders(){
  const t=document.getElementById('cfg-token').value.trim()||cfg.token||'';
  return {'Authorization':`token ${t}`,'Content-Type':'application/json'};
}
function ghBase(){
  let u=(document.getElementById('cfg-user').value.trim()||cfg.user||'boexaw');
  u=u.replace(/https?:\/\//gi,'').replace(/\.github\.io.*/gi,'').replace(/github\.com\//gi,'').replace(/\/.*$/,'').trim();
  const r=document.getElementById('cfg-repo').value.trim()||cfg.repo||'livingido-twmm';
  return `https://api.github.com/repos/${u}/${r}/contents`;
}

async function testGitHub(){
  setGhStatus('busy','Testing‚Ä¶');
  const t=document.getElementById('cfg-token').value.trim();
  if(!t){setGhStatus('err','Token ·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äò·Ä∞·Ä∏');return;}
  cfg.token=t;
  let rawUser=document.getElementById('cfg-user').value.trim();
  rawUser=rawUser.replace(/https?:\/\//gi,'').replace(/\.github\.io.*/gi,'').replace(/github\.com\//gi,'').replace(/\/.*$/,'').trim();
  document.getElementById('cfg-user').value=rawUser;
  cfg.user=rawUser;
  cfg.repo=document.getElementById('cfg-repo').value.trim();
  saveCfg();
  try{
    const r=await fetch(`https://api.github.com/repos/${cfg.user}/${cfg.repo}`,{headers:ghHeaders()});
    if(r.ok){
      const d=await r.json();
      setGhStatus('ok',`‚úì ${d.full_name} connected`);
      toast('GitHub connected!');
    } else {
      setGhStatus('err',`Error ${r.status} ‚Äî Token/Repo ·ÄÖ·ÄÖ·Ä∫·Äï·Ä´`);
    }
  }catch(e){setGhStatus('err','Network error: '+e.message);}
}

async function pushState(){
  setGhStatus('busy','Pushing state.json‚Ä¶');
  const state={
    match:matchData,
    poll:poll,
    updatedAt:new Date().toISOString(),
  };
  const content=btoa(unescape(encodeURIComponent(JSON.stringify(state,null,2))));
  const path=`${ghBase()}/data/state.json`;
  try{
    // Get current SHA if exists
    let sha='';
    try{
      const g=await fetch(path,{headers:ghHeaders()});
      if(g.ok){const d=await g.json();sha=d.sha;}
    }catch(e){}

    const body={message:`overlay: update state [${new Date().toLocaleTimeString()}]`,content};
    if(sha) body.sha=sha;

    const r=await fetch(path,{method:'PUT',headers:ghHeaders(),body:JSON.stringify(body)});
    if(r.ok){
      setGhStatus('ok','‚úì Pushed at '+new Date().toLocaleTimeString());
      setSyncStatus('ok','Synced '+new Date().toLocaleTimeString());
      toast('State pushed!');
    } else {
      const err=await r.json();
      setGhStatus('err','Push failed: '+(err.message||r.status));
    }
  }catch(e){setGhStatus('err','Error: '+e.message);}
}

function setGhStatus(cls,msg){
  document.getElementById('gh-status').innerHTML=`<div class="sdot ${cls}"></div><span>${msg}</span>`;
}
function setSyncStatus(cls,msg){
  document.getElementById('sync-dot').className=`sync-dot ${cls}`;
  document.getElementById('sync-txt').textContent=msg;
}

// ‚ïê‚ïê‚ïê FETCH STATE (OBS side) ‚ïê‚ïê‚ïê
async function fetchState(){
  if(!cfg.user||!cfg.repo) return;
  const user=(cfg.user||'').replace(/https?:\/\//gi,'').replace(/\.github\.io.*/gi,'').replace(/\/.*$/,'').trim();
  if(!user) return;
  try{
    // Use GitHub Contents API ‚Äî CORS safe
    const apiUrl=`https://api.github.com/repos/${user}/${cfg.repo}/contents/data/state.json`;
    const headers={'Accept':'application/vnd.github.v3.raw','Cache-Control':'no-cache'};
    if(cfg.token) headers['Authorization']=`token ${cfg.token}`;
    const r=await fetch(apiUrl,{headers});
    if(!r.ok) return;
    const d=await r.json();
    if(d.match){matchData=d.match;renderMatch();startCD();}
    if(d.poll){poll=d.poll;renderPoll();}
    setSyncStatus('ok','Synced '+new Date().toLocaleTimeString());
  }catch(e){
    setSyncStatus('err','Fetch error');
  }
}

// ‚ïê‚ïê‚ïê MATCH ACTIONS ‚ïê‚ïê‚ïê
function applyMatch(){
  matchData.homeTeam = document.getElementById('cfg-home').value||matchData.homeTeam;
  matchData.awayTeam = document.getElementById('cfg-away').value||matchData.awayTeam;
  matchData.homeId   = parseInt(document.getElementById('cfg-home-id').value)||matchData.homeId;
  matchData.awayId   = parseInt(document.getElementById('cfg-away-id').value)||matchData.awayId;
  const ko=document.getElementById('cfg-kickoff').value;
  if(ko) matchData.kickoff=new Date(ko).toISOString();
  renderMatch(); startCD(); pushState(); toast('Match applied!');
}
function adj(side,d){
  if(side==='home') matchData.homeScore=Math.max(0,(matchData.homeScore||0)+d);
  else matchData.awayScore=Math.max(0,(matchData.awayScore||0)+d);
  document.getElementById(`ctrl-${side==='home'?'hs':'as'}`).textContent=matchData[side+'Score'];
  document.getElementById(`ob-${side==='home'?'hs':'as'}`).textContent=matchData[side+'Score'];
  pushState();
}
function setState(s){
  matchData.matchState=s; renderMatch(); pushState(); toast('State: '+s.toUpperCase());
}

// ‚ïê‚ïê‚ïê RENDER MATCH ‚ïê‚ïê‚ïê
function makeBadge(tid,sz=26){
  const code=TB[tid];
  if(!code){const d=document.createElement('div');d.className='mt-badge-fb';d.style.width=sz+'px';d.style.height=sz+'px';d.textContent='‚öΩ';return d;}
  const img=document.createElement('img');img.className='mt-badge';img.style.width=sz+'px';img.style.height=sz+'px';img.src=BADGE(code);
  img.onerror=function(){const d=document.createElement('div');d.className='mt-badge-fb';d.style.width=sz+'px';d.style.height=sz+'px';d.textContent='‚öΩ';this.parentNode&&this.parentNode.replaceChild(d,this);};
  return img;
}
function renderMatch(){
  document.getElementById('ob-hname').textContent = matchData.homeTeam||'HOME';
  document.getElementById('ob-aname').textContent = matchData.awayTeam||'AWAY';
  document.getElementById('ob-hs').textContent    = matchData.homeScore||0;
  document.getElementById('ob-as').textContent    = matchData.awayScore||0;
  document.getElementById('gw-lbl').textContent   = `GW ${matchData.gw||'‚Äî'}`;
  const hb=document.getElementById('hb-wrap'); hb.innerHTML=''; hb.appendChild(makeBadge(matchData.homeId));
  const ab=document.getElementById('ab-wrap'); ab.innerHTML=''; ab.appendChild(makeBadge(matchData.awayId));
  const ms=matchData.matchState||'pre';
  const sb=document.getElementById('ob-state');
  sb.className='state-badge '+ms;
  sb.textContent=ms==='live'?`${matchData.liveMinute||1}'`:ms.toUpperCase();
  // sync ctrl
  document.getElementById('ctrl-hs').textContent=matchData.homeScore||0;
  document.getElementById('ctrl-as').textContent=matchData.awayScore||0;
  document.getElementById('home-ctrl-lbl').textContent=(matchData.homeTeam||'HOME').toUpperCase().slice(0,6);
  document.getElementById('away-ctrl-lbl').textContent=(matchData.awayTeam||'AWAY').toUpperCase().slice(0,6);
}

// ‚ïê‚ïê‚ïê COUNTDOWN ‚ïê‚ïê‚ïê
function startCD(){
  clearInterval(cdInt);
  const val=document.getElementById('cd-val');
  const dot=document.getElementById('cd-dot');
  if(!matchData.kickoff){val.textContent='--:--:--';return;}
  function tick(){
    const diff=new Date(matchData.kickoff).getTime()-Date.now();
    if(diff<=0){val.textContent='LIVE NOW';val.style.color='var(--dg)';dot.style.display='none';return;}
    dot.style.display='';
    const h=Math.floor(diff/3600000),m=Math.floor((diff%3600000)/60000),s=Math.floor((diff%60000)/1000);
    val.textContent=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    val.style.color='var(--am)';
  }
  tick(); cdInt=setInterval(tick,1000);
}

// ‚ïê‚ïê‚ïê TICKER ‚ïê‚ïê‚ïê
function renderTicker(fxs){
  if(!fxs||!fxs.length){document.getElementById('ticker').innerHTML='<div class="ticker-item" style="color:rgba(255,255,255,.3)">No fixtures</div>';return;}
  const mk=()=>fxs.map(f=>{
    const hs=f.homeScore!==null,isL=!f.finished&&hs,isFT=f.finished&&hs;
    const t=f.kickoff?new Date(f.kickoff).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}):'‚Äî';
    const sc=hs?`<span class="ts ${isL?'live':isFT?'ft':'up'}">${f.homeScore}-${f.awayScore}</span>`
              :`<span style="font-family:var(--fm);font-size:.62rem;color:rgba(255,255,255,.3)">${t}</span>`;
    return `<div class="ticker-item"><span>${f.homeShort||f.homeTeam}</span>${sc}<span>${f.awayShort||f.awayTeam}</span></div>`;
  }).join('');
  const inner=document.getElementById('ticker');
  inner.innerHTML=mk()+mk();
  requestAnimationFrame(()=>{inner.style.animationDuration=`${Math.max(18,inner.scrollWidth/2/60)}s`;});
}

// ‚ïê‚ïê‚ïê POLL ‚ïê‚ïê‚ïê
function applyPoll(){
  poll={question:document.getElementById('cfg-pq').value||'Community Poll',options:[document.getElementById('cfg-p1').value,document.getElementById('cfg-p2').value,document.getElementById('cfg-p3').value],votes:[0,0,0]};
  renderPoll(); renderPollPrev(); pushState(); toast('Poll reset!');
}
function tv(i){poll.votes[i]++;renderPoll();renderPollPrev();pushState();}
function renderPoll(){
  const p=poll,tot=p.votes.reduce((a,b)=>a+b,0)||1;
  document.getElementById('ob-pq').textContent=p.question;
  document.getElementById('ob-pbars').innerHTML=p.options.map((o,i)=>{
    const pct=Math.round(p.votes[i]/tot*100);
    return `<div class="pb-row"><span class="pb-lbl">${o}</span><div class="pb-wrap"><div class="pb-fill c${i}" style="width:${pct}%"></div></div><span class="pb-pct">${pct}%</span></div>`;
  }).join('');
}
function renderPollPrev(){
  const prev=document.getElementById('poll-prev'); if(!prev) return;
  const p=poll,tot=p.votes.reduce((a,b)=>a+b,0)||1;
  prev.innerHTML=p.options.map((o,i)=>{
    const pct=Math.round(p.votes[i]/tot*100);
    return `<div class="pp-row"><span class="pp-lbl">${o}</span><div class="pp-bar"><div class="pp-fill c${i}" style="width:${pct}%"></div></div><span class="pp-pct">${pct}%</span></div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê PREDICTION ‚ïê‚ïê‚ïê
function renderPred(cache){
  const saved=JSON.parse(localStorage.getItem(PRED_KEY)||'{}');
  const fxs=cache?.fixtures||[];
  const f=fxs.find(x=>!x.finished&&x.homeScore!==null)||fxs.find(x=>!x.finished)||fxs[0];
  if(!f) return;
  const p=saved[f.id]||{};
  document.getElementById('ob-ph').textContent=f.homeShort||f.homeTeam||'‚Äî';
  document.getElementById('ob-pa').textContent=f.awayShort||f.awayTeam||'‚Äî';
  document.getElementById('ob-phs').textContent=p.home??'?';
  document.getElementById('ob-pas').textContent=p.away??'?';
  document.getElementById('ob-ahs').textContent=f.homeScore??'?';
  document.getElementById('ob-aas').textContent=f.awayScore??'?';
  const res=document.getElementById('ob-res');
  if(f.finished&&p.home!==undefined){
    const ex=parseInt(p.home)===f.homeScore&&parseInt(p.away)===f.awayScore;
    const ok=ex||Math.sign(p.home-p.away)===Math.sign(f.homeScore-f.awayScore);
    res.textContent=ex?'üéØ EXACT':ok?'‚úì CORRECT':'‚úó WRONG';
    res.className='pred-res '+(ok?'correct':'wrong');
  }else if(f.homeScore!==null){res.textContent='‚óè LIVE';res.className='pred-res pending';}
  else{res.textContent='UPCOMING';res.className='pred-res pending';}
}

// ‚ïê‚ïê‚ïê CACHE (ticker + team) ‚ïê‚ïê‚ïê
async function loadCache(){
  try{
    const r=await fetch(CACHE+'?t='+Date.now());
    const d=await r.json();
    if(d.currentGW) document.getElementById('gw-lbl').textContent=`GW ${d.currentGW}`;
    renderTicker(d.fixtures||[]);
    renderPred(d);
    const team=d.team;
    if(team){
      document.getElementById('ob-pts').textContent=team.gwPoints??'‚Äî';
      const rk=team.overallRank;
      document.getElementById('ob-rank').textContent=rk?(rk>=1000?Math.round(rk/1000)+'K':rk):'‚Äî';
      const cap=team.starters?.find(p=>p.isCaptain);
      if(cap){
        document.getElementById('ob-cap-name').textContent=cap.name;
        document.getElementById('ob-cap-pts').textContent=`${cap.displayPts} pts √ó2`;
        const code=TB[cap.teamId];
        if(code){document.getElementById('ob-cap-kit').src=KIT(code,false);document.getElementById('ob-cap-kit').style.display='block';}
      }
      const hot=d.topPlayers?.[0];
      if(hot){
        document.getElementById('ob-hot-name').textContent=hot.name;
        document.getElementById('ob-hot-form').textContent=`Form ${hot.form}`;
        document.getElementById('ob-hot-price').textContent=`¬£${hot.price}m`;
        document.getElementById('ob-hot-fdr').className=`fdr-p fdr-${Math.min(5,hot.nextFDR||3)}`;
        const code=TB[hot.teamId];
        if(code){document.getElementById('ob-hot-kit').src=KIT(code,false);document.getElementById('ob-hot-kit').style.display='block';}
      }
    }
  }catch(e){}
}

// ‚ïê‚ïê‚ïê FPL LOAD ‚ïê‚ïê‚ïê
async function loadFPL(){
  const id=document.getElementById('cfg-tid').value.trim(); if(!id) return;
  const st=document.getElementById('fpl-status');
  st.innerHTML='<div class="sdot warn"></div><span>Loading‚Ä¶</span>';
  try{
    const boot=await fplFetch('/bootstrap-static/');
    boot.elements.forEach(p=>{allPlayers[p.id]=p;});
    boot.teams.forEach(t=>{allTeams[t.id]=t;});
    const entry=await fplFetch(`/entry/${id}/`);
    const gw=entry.current_event;
    const picks=await fplFetch(`/entry/${id}/event/${gw}/picks/`);
    document.getElementById('ob-pts').textContent=picks.entry_history?.points||0;
    const rk=entry.summary_overall_rank;
    document.getElementById('ob-rank').textContent=rk?(rk>=1000?Math.round(rk/1000)+'K':rk):'‚Äî';
    matchData.gw=gw;
    const cap=picks.picks.find(p=>p.is_captain);
    if(cap){
      const pl=allPlayers[cap.element];
      if(pl){
        document.getElementById('ob-cap-name').textContent=pl.web_name;
        document.getElementById('ob-cap-pts').textContent=`${pl.event_points*2} pts √ó2`;
        const code=TB[pl.team];
        if(code){document.getElementById('ob-cap-kit').src=KIT(code,false);document.getElementById('ob-cap-kit').style.display='block';}
      }
    }
    localStorage.setItem('fplTeamId',id);
    st.innerHTML=`<div class="sdot ok"></div><span>‚úì ${entry.name} ¬∑ GW${gw}</span>`;
    pushState(); toast('FPL loaded!');
  }catch(e){st.innerHTML=`<div class="sdot err"></div><span>${e.message}</span>`;}
}
async function fplFetch(p){
  const url=FPL_API+p;
  for(const px of PROXIES){try{const r=await fetch(px+encodeURIComponent(url));if(r.ok)return r.json();}catch(e){}}
  throw new Error('Proxies failed');
}

// ‚ïê‚ïê‚ïê WIDGET TOGGLES ‚ïê‚ïê‚ïê
const W_MAP={ticker:'w-ticker',countdown:'w-countdown',match:'w-match',myteam:'w-myteam',cap:'w-cap',hot:'w-hot',pred:'w-pred',poll:'w-poll'};
function togW(k){
  widgets[k]=widgets[k]?0:1;
  const b=document.getElementById(`tog-${k}`);
  b.className='tog '+(widgets[k]?'on':'off');
  const el=document.getElementById(W_MAP[k]);
  if(el){el.style.display=widgets[k]?'':'none';const dv=el.nextSibling;if(dv&&dv.className==='div')dv.style.display=widgets[k]?'':'none';}
  cfg.widgets=widgets; saveCfg();
}

// ‚ïê‚ïê‚ïê INTERVAL ‚ïê‚ïê‚ïê
function applyInterval(){
  const ms=parseInt(document.getElementById('cfg-interval').value)||10000;
  cfg.interval=ms; saveCfg();
  clearInterval(fetchInt);
  fetchInt=setInterval(fetchState,ms);
  toast(`Refresh: ${ms/1000}s`);
}

// ‚ïê‚ïê‚ïê URL ‚ïê‚ïê‚ïê
function cleanUser(el){
  // Strip .github.io and https:// if accidentally pasted
  let v=el.value.trim();
  v=v.replace(/https?:\/\//gi,'');
  v=v.replace(/\.github\.io.*/gi,'');
  v=v.replace(/github\.com\//gi,'');
  v=v.replace(/\/.*$/,'');
  if(el.value!==v){ el.value=v; }
  cfg.user=v; saveCfg(); updateURL();
}
function updateURL(){
  const u=document.getElementById('cfg-user').value.trim()||'[username]';
  const r=document.getElementById('cfg-repo').value.trim()||'livingido-twmm';
  const t=document.getElementById('cfg-token').value.trim();
  const tokenPart=t?`&token=${t}`:'';
  const url=`https://${u}.github.io/${r}/overlay.html?obs=true${tokenPart}`;
  document.getElementById('obs-url').textContent=url;
}
function copyURL(){navigator.clipboard.writeText(document.getElementById('obs-url').textContent).then(()=>toast('URL copied!'));}

// ‚ïê‚ïê‚ïê RESET ‚ïê‚ïê‚ïê
function resetAll(){if(!confirm('Reset?'))return;localStorage.removeItem(OVL_KEY);location.reload();}

// ‚ïê‚ïê‚ïê SAVE CFG ‚ïê‚ïê‚ïê
function saveCfg(){
  // Don't store token in plaintext if empty
  const t=document.getElementById('cfg-token')?.value.trim();
  if(t) cfg.token=t;
  localStorage.setItem(OVL_KEY,JSON.stringify(cfg));
}

// ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê
function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.style.opacity='1';
  clearTimeout(t._t);t._t=setTimeout(()=>t.style.opacity='0',2000);
}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
async function init(){
  checkMode();
  // Apply saved widget visibility
  Object.keys(widgets).forEach(k=>{
    if(!widgets[k]){
      const el=document.getElementById(W_MAP[k]);
      if(el){el.style.display='none';const dv=el.nextSibling;if(dv&&dv.className==='div')dv.style.display='none';}
    }
  });
  // Restore match data from last push
  // Load saved cfg into inputs if settings panel opened later
  if(cfg.token) document.getElementById('cfg-token').value=cfg.token;
  if(cfg.user)  document.getElementById('cfg-user').value=cfg.user;
  if(cfg.repo)  document.getElementById('cfg-repo').value=cfg.repo||'livingido-twmm';
  if(cfg.user&&cfg.repo){
    await fetchState();
  }
  renderMatch();
  startCD();
  renderPoll();
  await loadCache();
  // Fetch interval (OBS auto-sync)
  const ms=cfg.interval||10000;
  fetchInt=setInterval(fetchState,ms);
  // cache refresh every 60s
  setInterval(loadCache,60000);
}

init();
</script>
</body>
</html>
